<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logfolio - ä¸ªäººå¹´åº¦æˆå°±å¢™</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="header-container"></div>

    <main class="main">
        <div class="container">
            <!-- å·¥å…·æ ï¼šæœç´¢æ¡†ï¼ˆæ»šåŠ¨æ—¶æ˜¾ç¤ºï¼‰ -->
            <div class="toolbar" id="toolbar-container">
                <div class="search-wrapper" id="search-wrapper" style="display: none;">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="search-input" class="search-input" placeholder="æœç´¢è®°å½•...">
                    <button id="search-clear" class="search-clear" style="display: none;">âœ•</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯å’Œç­›é€‰å™¨æ•´åˆé¢æ¿ -->
            <div id="statistics" class="statistics"></div>

            <!-- åŠ è½½æç¤º -->
            <div id="loading" class="loading" style="display: none;">åŠ è½½ä¸­...</div>
            
            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">ğŸ‚</div>
                <p>è¿™é‡Œè¿˜ä»€ä¹ˆéƒ½æ²¡æœ‰</p>
                <a href="/add" class="btn btn-primary">å»è®°å½•ä¸€ç¬”</a>
            </div>

            <!-- æµ·æŠ¥å¢™å®¹å™¨ -->
            <div id="items-grid" class="items-grid"></div>
        </div>
    </main>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/components.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let allItems = [];
        let filteredItems = [];
        let categories = [];
        let currentFilters = {};

        // åˆå§‹åŒ–
        async function init() {
            renderHeader('index');
            setupSearch();
            await loadCategories();
            setupFilters(); // å…ˆè®¾ç½®ç­›é€‰å™¨ï¼ˆåŒ…æ‹¬é»˜è®¤å¹´ä»½ï¼‰
            // ä½¿ç”¨é»˜è®¤å¹´ä»½åŠ è½½æ•°æ®
            const currentYear = new Date().getFullYear();
            await loadItems({ year: currentYear }, '', currentYear.toString());
            
            // è®¾ç½®é»˜è®¤é€‰ä¸­çŠ¶æ€
            setTimeout(() => {
                const defaultYearItem = document.querySelector(`.stat-year-item[data-year="${currentYear}"]`);
                if (defaultYearItem) {
                    defaultYearItem.classList.add('active');
                }
                const allCategoryItem = document.querySelector('.stat-category-item[data-category-id=""]');
                if (allCategoryItem) {
                    allCategoryItem.classList.add('active');
                }
            }, 100);
        }
        
        // è®¾ç½®æœç´¢åŠŸèƒ½
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            const searchClear = document.getElementById('search-clear');
            
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const value = e.target.value.trim();
                    if (searchClear) {
                        searchClear.style.display = value ? 'block' : 'none';
                    }
                    if (typeof window.handleSearch === 'function') {
                        window.handleSearch(value);
                    }
                });
            }
            
            if (searchClear) {
                searchClear.addEventListener('click', function() {
                    if (searchInput) {
                        searchInput.value = '';
                        searchClear.style.display = 'none';
                        if (typeof window.handleSearch === 'function') {
                            window.handleSearch('');
                        }
                    }
                });
            }
        }

        // åŠ è½½åˆ†ç±»åˆ—è¡¨å¹¶æ¸²æŸ“ä¸º tab
        async function loadCategories() {
            try {
                categories = await CategoriesAPI.getAll();
                
                // åˆ›å»ºä¸´æ—¶çš„åˆ†ç±»tabså®¹å™¨ï¼ˆç”¨äºè·å–HTMLï¼‰
                const tempContainer = document.createElement('div');
                tempContainer.id = 'category-filter-tabs';
                tempContainer.className = 'category-filter-tabs';
                
                // æ·»åŠ "å…¨éƒ¨"æŒ‰é’®
                const allTab = document.createElement('button');
                allTab.type = 'button';
                allTab.className = 'category-filter-tab active';
                allTab.textContent = 'å…¨éƒ¨';
                allTab.dataset.categoryId = '';
                tempContainer.appendChild(allTab);
                
                // æ·»åŠ å…¶ä»–åˆ†ç±» tab
                categories.forEach(cat => {
                    const tab = document.createElement('button');
                    tab.type = 'button';
                    tab.className = 'category-filter-tab';
                    tab.textContent = cat.name;
                    tab.dataset.categoryId = cat.id;
                    tempContainer.appendChild(tab);
                });
                
                // å°†ä¸´æ—¶å®¹å™¨æ·»åŠ åˆ°é¡µé¢ï¼ˆéšè—ï¼‰
                tempContainer.style.display = 'none';
                document.body.appendChild(tempContainer);
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
                tempContainer.addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-filter-tab')) {
                        // ç§»é™¤æ‰€æœ‰ tab çš„ active çŠ¶æ€
                        document.querySelectorAll('.category-filter-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        // æ·»åŠ å½“å‰ tab çš„ active çŠ¶æ€
                        e.target.classList.add('active');
                        
                        // åº”ç”¨ç­›é€‰
                        applyFilters();
                    }
                });
            } catch (error) {
                showMessage('åŠ è½½åˆ†ç±»å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½è®°å½•åˆ—è¡¨
        async function loadItems(params = {}, categoryId = '', year = '') {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const grid = document.getElementById('items-grid');
            
            loading.style.display = 'block';
            grid.innerHTML = '';
            
            try {
                allItems = await ItemsAPI.getAll(params);
                currentFilters = params;
                filteredItems = [...allItems];
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯ï¼ˆä¼ å…¥å½“å‰ç­›é€‰æ¡ä»¶ï¼‰
                const statsYear = params.year || new Date().getFullYear();
                const statsCategoryId = categoryId || params.category_id || '';
                await showStatistics(statsYear.toString(), statsCategoryId);
                
                loading.style.display = 'none';
                
                if (filteredItems.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                renderItems(filteredItems);
            } catch (error) {
                loading.style.display = 'none';
                showMessage('åŠ è½½è®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æœç´¢å¤„ç†
        window.handleSearch = debounce(function(searchTerm) {
            if (!searchTerm.trim()) {
                filteredItems = [...allItems];
            } else {
                const term = searchTerm.toLowerCase();
                filteredItems = allItems.filter(item => {
                    const titleMatch = item.title.toLowerCase().includes(term);
                    const notesMatch = item.notes && item.notes.toLowerCase().includes(term);
                    return titleMatch || notesMatch;
                });
            }
            
            const emptyState = document.getElementById('empty-state');
            const grid = document.getElementById('items-grid');
            
            if (filteredItems.length === 0) {
                emptyState.style.display = 'block';
                grid.innerHTML = '';
            } else {
                emptyState.style.display = 'none';
                renderItems(filteredItems);
            }
        }, 300);

        // æ¸²æŸ“è®°å½•å¡ç‰‡
        function renderItems(items) {
            const grid = document.getElementById('items-grid');
            grid.innerHTML = '';
            
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                
                // ç‚¹å‡»æ•´ä¸ªå¡ç‰‡æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
                card.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘è¯¦æƒ…æ˜¾ç¤º
                    if (e.target.closest('.item-delete-btn')) {
                        return;
                    }
                    showItemDetail(item);
                };
                
                // å°é¢å›¾ç‰‡ï¼ˆä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºå ä½ç¬¦ï¼‰
                const coverImage = item.images && item.images.length > 0 
                    ? item.images[0].image_url 
                    : '/static/images/placeholder.svg';
                
                // ç®€æ´ç‰ˆå¡ç‰‡ç»“æ„ï¼šé€‚åˆç§»åŠ¨ç«¯çš„è§†è§‰æµï¼Œå¸¦å·¦ä¸Šè§’å¾½ç« 
                card.innerHTML = `
                    <div class="item-card-image">
                        <div class="item-badge">${item.category_name}</div>
                        <img src="${coverImage}" loading="lazy" alt="${item.title}" onerror="this.src='/static/images/placeholder.svg'">
                        <div class="item-overlay">
                            <h3 class="item-title">${item.title}</h3>
                            <div class="item-meta">
                                <span>${formatDate(item.finish_time)}</span>
                                ${item.images && item.images.length > 1 ? `<span>ğŸ“· ${item.images.length}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // æ·»åŠ åˆ é™¤æŒ‰é’®ï¼ˆæ‚¬åœ/é•¿æŒ‰æ—¶æ˜¾ç¤ºï¼‰
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'item-delete-btn';
                deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                deleteBtn.title = 'åˆ é™¤';
                deleteBtn.style.display = 'none';
                
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // é˜»æ­¢è§¦å‘å¡ç‰‡ç‚¹å‡»äº‹ä»¶
                    showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', () => {
                        deleteItem(item.id);
                    });
                });
                
                card.appendChild(deleteBtn);
                
                // ç§»åŠ¨ç«¯ï¼šé•¿æŒ‰æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼ˆå»¶é•¿åˆ°2ç§’ï¼‰
                let longPressTimer;
                let isLongPress = false;
                let deleteBtnVisible = false;
                
                card.addEventListener('touchstart', function(e) {
                    isLongPress = false;
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        deleteBtnVisible = true;
                        e.preventDefault();
                        // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                        deleteBtn.style.display = 'flex';
                        // æ·»åŠ éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                        if (navigator.vibrate) {
                            navigator.vibrate([50, 30, 50]);
                        }
                        // æ·»åŠ è§†è§‰åé¦ˆ
                        card.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            card.style.transform = '';
                        }, 200);
                    }, 2000); // æ”¹ä¸º2ç§’
                });
                
                card.addEventListener('touchend', function() {
                    clearTimeout(longPressTimer);
                    // å¦‚æœé•¿æŒ‰å®Œæˆï¼Œä¿æŒæŒ‰é’®æ˜¾ç¤º
                    if (isLongPress && deleteBtnVisible) {
                        // æŒ‰é’®ä¿æŒæ˜¾ç¤ºï¼Œç›´åˆ°ç”¨æˆ·ç‚¹å‡»åˆ é™¤æˆ–ç‚¹å‡»å…¶ä»–åœ°æ–¹
                        return;
                    }
                    // å¦‚æœæœªå®Œæˆé•¿æŒ‰ï¼Œéšè—æŒ‰é’®
                    if (!isLongPress) {
                        deleteBtn.style.display = 'none';
                    }
                });
                
                card.addEventListener('touchmove', function() {
                    clearTimeout(longPressTimer);
                    isLongPress = false;
                    deleteBtnVisible = false;
                    deleteBtn.style.display = 'none';
                });
                
                // ç‚¹å‡»å¡ç‰‡å…¶ä»–åœ°æ–¹æ—¶ï¼Œå¦‚æœåˆ é™¤æŒ‰é’®å·²æ˜¾ç¤ºï¼Œåˆ™éšè—å®ƒ
                card.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸”åˆ é™¤æŒ‰é’®å·²æ˜¾ç¤ºï¼Œåˆ™éšè—å®ƒ
                    if (deleteBtnVisible && e.target !== deleteBtn && !deleteBtn.contains(e.target)) {
                        deleteBtn.style.display = 'none';
                        deleteBtnVisible = false;
                    }
                });
                
                // PCç«¯ï¼šæ‚¬åœæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                card.addEventListener('mouseenter', function() {
                    deleteBtn.style.display = 'flex';
                });
                
                card.addEventListener('mouseleave', function() {
                    deleteBtn.style.display = 'none';
                });
                
                // PCç«¯å³é”®èœå•åˆ é™¤
                card.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', () => {
                        deleteItem(item.id);
                    });
                });
                
                grid.appendChild(card);
            });
        }

        // è®¾ç½®ç­›é€‰å™¨
        async function setupFilters() {
            // åˆ›å»ºå¹´ä»½é€‰æ‹©å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let yearFilter = document.getElementById('year-filter');
            if (!yearFilter) {
                yearFilter = document.createElement('select');
                yearFilter.id = 'year-filter';
                yearFilter.className = 'filter-select';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'å…¨éƒ¨å¹´ä»½';
                yearFilter.appendChild(defaultOption);
                document.body.appendChild(yearFilter);
                yearFilter.style.display = 'none';
            }
            
            // ä»APIè·å–æœ‰è®°å½•çš„å¹´ä»½
            try {
                const response = await ItemsAPI.getAvailableYears();
                const years = response.years || [];
                const currentYear = new Date().getFullYear();
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªï¼‰
                while (yearFilter.children.length > 1) {
                    yearFilter.removeChild(yearFilter.lastChild);
                }
                
                // å¦‚æœæœ‰è®°å½•çš„å¹´ä»½åˆ—è¡¨ä¸ºç©ºï¼Œä½¿ç”¨å½“å‰å¹´
                if (years.length === 0) {
                    years.push(currentYear);
                }
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    // è®¾ç½®å½“å‰å¹´ä¸ºé»˜è®¤é€‰ä¸­ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearFilter.appendChild(option);
                });
                
                // å¦‚æœæ²¡æœ‰å½“å‰å¹´ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¹´ä»½
                if (!yearFilter.value && years.length > 0) {
                    yearFilter.value = years[0];
                }
            } catch (error) {
                console.error('è·å–å¹´ä»½åˆ—è¡¨å¤±è´¥:', error);
                // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å¹´ä»½åˆ—è¡¨
                const years = getYearOptions(2020);
                const currentYear = new Date().getFullYear();
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearFilter.appendChild(option);
                });
            }
            
            // è®¾ç½®æ»šåŠ¨ç›‘å¬ï¼Œæ˜¾ç¤ºæœç´¢æ¡†
            setupScrollSearch();
        }
        
        // è®¾ç½®ç­›é€‰å™¨äº‹ä»¶ï¼ˆåœ¨ç»Ÿè®¡å¡ç‰‡å†…éƒ¨ï¼‰
        window.setupFilterEvents = function() {
            // ç»‘å®šåˆ†ç±»tabsäº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
            const categoryTabsInner = document.getElementById('category-filter-tabs-inner');
            if (categoryTabsInner) {
                categoryTabsInner.addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-filter-tab')) {
                        // åŒæ­¥æ›´æ–°éšè—çš„åŸå§‹tabs
                        const originalTabs = document.getElementById('category-filter-tabs');
                        if (originalTabs) {
                            originalTabs.querySelectorAll('.category-filter-tab').forEach(t => {
                                t.classList.remove('active');
                                if (t.dataset.categoryId === e.target.dataset.categoryId) {
                                    t.classList.add('active');
                                }
                            });
                        }
                        
                        // ç§»é™¤æ‰€æœ‰ tab çš„ active çŠ¶æ€
                        document.querySelectorAll('.category-filter-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        // æ·»åŠ å½“å‰ tab çš„ active çŠ¶æ€
                        e.target.classList.add('active');
                        
                        // åº”ç”¨ç­›é€‰
                        applyFilters();
                    }
                });
            }
            
            // ç»‘å®šå¹´ä»½é€‰æ‹©å™¨äº‹ä»¶
            const yearFilterInner = document.getElementById('year-filter-inner');
            if (yearFilterInner) {
                yearFilterInner.addEventListener('change', function() {
                    // åŒæ­¥æ›´æ–°åŸå§‹çš„å¹´ä»½é€‰æ‹©å™¨
                    const originalYearFilter = document.getElementById('year-filter');
                    if (originalYearFilter && originalYearFilter !== yearFilterInner) {
                        originalYearFilter.value = this.value;
                    }
                    applyFilters();
                });
            }
        };
        
        // è®¾ç½®æ»šåŠ¨ç›‘å¬ï¼Œå½“ç”¨æˆ·æ»šåŠ¨æ—¶æ˜¾ç¤ºæœç´¢æ¡†
        function setupScrollSearch() {
            const searchWrapper = document.getElementById('search-wrapper');
            let lastScrollTop = 0;
            let scrollTimeout;
            
            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                clearTimeout(scrollTimeout);
                
                // å¦‚æœå‘ä¸‹æ»šåŠ¨è¶…è¿‡ 100pxï¼Œæ˜¾ç¤ºæœç´¢æ¡†
                if (scrollTop > 100 && scrollTop > lastScrollTop) {
                    searchWrapper.style.display = 'block';
                    searchWrapper.style.opacity = '0';
                    setTimeout(() => {
                        searchWrapper.style.transition = 'opacity 0.3s';
                        searchWrapper.style.opacity = '1';
                    }, 10);
                }
                
                // å¦‚æœæ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œéšè—æœç´¢æ¡†
                if (scrollTop < 50) {
                    searchWrapper.style.opacity = '0';
                    scrollTimeout = setTimeout(() => {
                        searchWrapper.style.display = 'none';
                    }, 300);
                }
                
                lastScrollTop = scrollTop;
            });
        }

        // é€šè¿‡åˆ†ç±»ç­›é€‰
        window.filterByCategory = function(categoryId) {
            // æ›´æ–°åˆ†ç±»é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.stat-category-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.categoryId === categoryId) {
                    item.classList.add('active');
                }
            });
            
            // è·å–å½“å‰é€‰ä¸­çš„å¹´ä»½
            const activeYearItem = document.querySelector('.stat-year-item.active');
            const year = activeYearItem ? activeYearItem.dataset.year : '';
            
            const params = {};
            if (categoryId) params.category_id = categoryId;
            if (year) params.year = parseInt(year);
            
            // æ¸…é™¤æœç´¢æ¡†
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                if (typeof window.handleSearch === 'function') {
                    window.handleSearch('');
                }
            }
            const searchClear = document.getElementById('search-clear');
            if (searchClear) searchClear.style.display = 'none';
            
            loadItems(params, categoryId, year);
        };
        
        // é€šè¿‡å¹´ä»½ç­›é€‰
        window.filterByYear = function(year) {
            // æ›´æ–°å¹´ä»½é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.stat-year-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.year === year) {
                    item.classList.add('active');
                }
            });
            
            // è·å–å½“å‰é€‰ä¸­çš„åˆ†ç±»
            const activeCategoryItem = document.querySelector('.stat-category-item.active');
            const categoryId = activeCategoryItem ? activeCategoryItem.dataset.categoryId : '';
            
            const params = {};
            if (categoryId) params.category_id = categoryId;
            if (year) params.year = parseInt(year);
            
            // æ¸…é™¤æœç´¢æ¡†
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                if (typeof window.handleSearch === 'function') {
                    window.handleSearch('');
                }
            }
            const searchClear = document.getElementById('search-clear');
            if (searchClear) searchClear.style.display = 'none';
            
            loadItems(params, categoryId, year);
        };
        
        // åº”ç”¨ç­›é€‰ï¼ˆä¿ç•™ç”¨äºå…¶ä»–åœºæ™¯ï¼‰
        function applyFilters() {
            // è·å–é€‰ä¸­çš„åˆ†ç±»
            const activeCategoryItem = document.querySelector('.stat-category-item.active');
            const categoryId = activeCategoryItem ? activeCategoryItem.dataset.categoryId : '';
            
            // è·å–é€‰ä¸­çš„å¹´ä»½
            const activeYearItem = document.querySelector('.stat-year-item.active');
            const year = activeYearItem ? activeYearItem.dataset.year : '';
            
            const params = {};
            if (categoryId) params.category_id = categoryId;
            if (year) params.year = parseInt(year);
            
            // æ¸…é™¤æœç´¢æ¡†
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                if (typeof window.handleSearch === 'function') {
                    window.handleSearch('');
                }
            }
            const searchClear = document.getElementById('search-clear');
            if (searchClear) searchClear.style.display = 'none';
            
            loadItems(params, categoryId, year);
        }

        // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
        function showItemDetail(item) {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'item-detail-overlay';
            
            // åˆ›å»ºè¯¦æƒ…å¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.className = 'item-detail-dialog';
            
            // æ„å»ºå›¾ç‰‡ç½‘æ ¼
            let imagesHTML = '';
            if (item.images && item.images.length > 0) {
                imagesHTML = `
                    <div class="item-detail-images" id="item-detail-images-${item.id}">
                        ${item.images.map((img, idx) => `
                            <div class="item-detail-image-item" data-image-id="${img.id}">
                                <img src="${img.image_url}" alt="å›¾ç‰‡ ${idx + 1}">
                                <button class="item-image-delete" onclick="deleteImageFromDetail(${img.id}, ${item.id}, this.closest('.item-detail-overlay'))" title="åˆ é™¤å›¾ç‰‡">âœ•</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                imagesHTML = `<div class="item-detail-images" id="item-detail-images-${item.id}"></div>`;
            }
            
            dialog.innerHTML = `
                <div class="item-detail-content">
                    <button class="item-detail-close" onclick="closeDetailDialog(this.closest('.item-detail-overlay'))">âœ•</button>
                    <div class="item-detail-header">
                        <div class="item-detail-badge">${item.category_name}</div>
                        <h2 class="item-detail-title">${item.title}</h2>
                        <div class="item-detail-date">
                            <span class="date-icon">ğŸ“…</span>
                            ${formatDate(item.finish_time)}
                        </div>
                    </div>
                    ${item.notes ? `
                        <div class="item-detail-notes">
                            <h3>å¤‡æ³¨/æ„Ÿæƒ³</h3>
                            <p>${item.notes}</p>
                        </div>
                    ` : ''}
                    <div class="item-detail-images-section">
                        <div class="item-detail-images-header">
                            <h3>å›¾ç‰‡</h3>
                            <label class="btn btn-secondary btn-sm" style="margin: 0;">
                                æ·»åŠ å›¾ç‰‡
                                <input type="file" 
                                       id="add-images-${item.id}" 
                                       multiple 
                                       accept="image/*" 
                                       style="display: none;"
                                       onchange="handleAddImages(${item.id}, this.closest('.item-detail-overlay'))">
                            </label>
                        </div>
                        ${imagesHTML}
                    </div>
                    <div class="item-detail-actions">
                        <button class="btn btn-danger" onclick="deleteItemFromDetail(${item.id}, this.closest('.item-detail-overlay'))">åˆ é™¤è®°å½•</button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // å­˜å‚¨å½“å‰itemæ•°æ®åˆ°overlayï¼Œæ–¹ä¾¿åç»­æ›´æ–°
            overlay.dataset.itemId = item.id;
            overlay.dataset.currentImages = JSON.stringify(item.images || []);
            
            // ä¸ºå›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæŸ¥çœ‹å¤§å›¾ï¼‰
            const imageItems = dialog.querySelectorAll('.item-detail-image-item');
            imageItems.forEach((itemEl, idx) => {
                const img = itemEl.querySelector('img');
                if (img) {
                    img.addEventListener('click', (e) => {
                        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯åˆ é™¤æŒ‰é’®ï¼Œåˆ™æŸ¥çœ‹å¤§å›¾
                        if (!e.target.closest('.item-image-delete')) {
                            const currentImages = JSON.parse(overlay.dataset.currentImages);
                            createImageViewer(currentImages, idx);
                        }
                    });
                }
            });
            
            // æ·»åŠ åŠ¨ç”»
            setTimeout(() => {
                overlay.classList.add('show');
            }, 10);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDetailDialog(overlay);
                }
            });
            
            // ESC é”®å…³é—­
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeDetailDialog(overlay);
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // å¤„ç†æ·»åŠ å›¾ç‰‡
        async function handleAddImages(itemId, overlay) {
            const fileInput = document.getElementById(`add-images-${itemId}`);
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                return;
            }
            
            try {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }
                
                const newImages = await ItemsAPI.addImages(itemId, formData);
                
                // æ›´æ–°overlayä¸­çš„å›¾ç‰‡æ•°æ®
                const currentImages = JSON.parse(overlay.dataset.currentImages || '[]');
                currentImages.push(...newImages);
                overlay.dataset.currentImages = JSON.stringify(currentImages);
                
                // é‡æ–°æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
                const imagesContainer = overlay.querySelector(`#item-detail-images-${itemId}`);
                const existingImages = currentImages;
                
                imagesContainer.innerHTML = existingImages.map((img, idx) => `
                    <div class="item-detail-image-item" data-image-id="${img.id}">
                        <img src="${img.image_url}" alt="å›¾ç‰‡ ${idx + 1}">
                        <button class="item-image-delete" onclick="deleteImageFromDetail(${img.id}, ${itemId}, this.closest('.item-detail-overlay'))" title="åˆ é™¤å›¾ç‰‡">âœ•</button>
                    </div>
                `).join('');
                
                // é‡æ–°ç»‘å®šå›¾ç‰‡ç‚¹å‡»äº‹ä»¶
                const imageItems = imagesContainer.querySelectorAll('.item-detail-image-item');
                imageItems.forEach((itemEl, idx) => {
                    const img = itemEl.querySelector('img');
                    if (img) {
                        img.addEventListener('click', (e) => {
                            if (!e.target.closest('.item-image-delete')) {
                                createImageViewer(existingImages, idx);
                            }
                        });
                    }
                });
                
                showMessage('å›¾ç‰‡æ·»åŠ æˆåŠŸ', 'success');
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                fileInput.value = '';
                
                // åˆ·æ–°åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
                applyFilters();
            } catch (error) {
                showMessage('æ·»åŠ å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤å›¾ç‰‡
        async function deleteImageFromDetail(imageId, itemId, overlay) {
            showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ', async () => {
                try {
                    await ItemsAPI.deleteImage(imageId);
                    
                    // æ›´æ–°overlayä¸­çš„å›¾ç‰‡æ•°æ®
                    const currentImages = JSON.parse(overlay.dataset.currentImages || '[]');
                    const updatedImages = currentImages.filter(img => img.id !== imageId);
                    overlay.dataset.currentImages = JSON.stringify(updatedImages);
                    
                    // é‡æ–°æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
                    const imagesContainer = overlay.querySelector(`#item-detail-images-${itemId}`);
                    
                    if (updatedImages.length === 0) {
                        imagesContainer.innerHTML = '';
                    } else {
                        imagesContainer.innerHTML = updatedImages.map((img, idx) => `
                            <div class="item-detail-image-item" data-image-id="${img.id}">
                                <img src="${img.image_url}" alt="å›¾ç‰‡ ${idx + 1}">
                                <button class="item-image-delete" onclick="deleteImageFromDetail(${img.id}, ${itemId}, this.closest('.item-detail-overlay'))" title="åˆ é™¤å›¾ç‰‡">âœ•</button>
                            </div>
                        `).join('');
                        
                        // é‡æ–°ç»‘å®šå›¾ç‰‡ç‚¹å‡»äº‹ä»¶
                        const imageItems = imagesContainer.querySelectorAll('.item-detail-image-item');
                        imageItems.forEach((itemEl, idx) => {
                            const img = itemEl.querySelector('img');
                            if (img) {
                                img.addEventListener('click', (e) => {
                                    if (!e.target.closest('.item-image-delete')) {
                                        createImageViewer(updatedImages, idx);
                                    }
                                });
                            }
                        });
                    }
                    
                    showMessage('å›¾ç‰‡åˆ é™¤æˆåŠŸ', 'success');
                    
                    // åˆ·æ–°åˆ—è¡¨
                    applyFilters();
                } catch (error) {
                    showMessage('åˆ é™¤å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
                }
            });
        }
        
        // å…³é—­è¯¦æƒ…å¯¹è¯æ¡†
        function closeDetailDialog(overlay) {
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }
        
        // ä»è¯¦æƒ…å¯¹è¯æ¡†åˆ é™¤è®°å½•
        async function deleteItemFromDetail(id, overlay) {
            showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', async () => {
                try {
                    await ItemsAPI.delete(id);
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    closeDetailDialog(overlay);
                    applyFilters(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } catch (error) {
                    showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            });
        }
        
        // åˆ é™¤è®°å½•
        async function deleteItem(id) {
            try {
                await ItemsAPI.delete(id);
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                applyFilters(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
