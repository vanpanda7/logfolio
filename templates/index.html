<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logfolio - ä¸ªäººå¹´åº¦æ–‡åŒ–æˆå°±å¢™</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="header-container"></div>

    <main class="main">
        <div class="container">
            <!-- æœç´¢æ¡† -->
            <div id="search-container"></div>

            <!-- ç­›é€‰æ  -->
            <div class="filters">
                <div class="filter-group">
                    <label for="category-filter">åˆ†ç±»ï¼š</label>
                    <select id="category-filter" class="filter-select">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="year-filter">å¹´ä»½ï¼š</label>
                    <select id="year-filter" class="filter-select">
                        <option value="">å…¨éƒ¨</option>
                    </select>
                </div>
                <button id="clear-filters" class="btn btn-secondary">æ¸…é™¤ç­›é€‰</button>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div id="statistics" class="statistics"></div>

            <!-- åŠ è½½æç¤º -->
            <div id="loading" class="loading">åŠ è½½ä¸­...</div>

            <!-- æµ·æŠ¥å¢™å®¹å™¨ -->
            <div id="items-grid" class="items-grid"></div>

            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <p>æš‚æ— è®°å½•ï¼Œ<a href="/add">æ·»åŠ ç¬¬ä¸€æ¡è®°å½•</a>å§ï¼</p>
            </div>
        </div>
    </main>

    <script src="/static/js/api.js"></script>
    <script src="/static/js/app.js"></script>
    <script src="/static/js/components.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let allItems = [];
        let filteredItems = [];
        let categories = [];
        let currentFilters = {};

        // åˆå§‹åŒ–
        async function init() {
            renderHeader('index');
            createSearchBox();
            await loadCategories();
            await loadItems();
            setupFilters();
        }

        // åŠ è½½åˆ†ç±»åˆ—è¡¨
        async function loadCategories() {
            try {
                categories = await CategoriesAPI.getAll();
                const categorySelect = document.getElementById('category-filter');
                
                // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
                categorySelect.innerHTML = '<option value="">å…¨éƒ¨</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                showMessage('åŠ è½½åˆ†ç±»å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½è®°å½•åˆ—è¡¨
        async function loadItems(params = {}) {
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const grid = document.getElementById('items-grid');
            
            loading.style.display = 'block';
            grid.innerHTML = '';
            
            try {
                allItems = await ItemsAPI.getAll(params);
                currentFilters = params;
                filteredItems = [...allItems];
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                const year = params.year || new Date().getFullYear();
                await showStatistics(year);
                
                loading.style.display = 'none';
                
                if (filteredItems.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                renderItems(filteredItems);
            } catch (error) {
                loading.style.display = 'none';
                showMessage('åŠ è½½è®°å½•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // æœç´¢å¤„ç†
        window.handleSearch = debounce(function(searchTerm) {
            if (!searchTerm.trim()) {
                filteredItems = [...allItems];
            } else {
                const term = searchTerm.toLowerCase();
                filteredItems = allItems.filter(item => {
                    const titleMatch = item.title.toLowerCase().includes(term);
                    const notesMatch = item.notes && item.notes.toLowerCase().includes(term);
                    return titleMatch || notesMatch;
                });
            }
            
            const emptyState = document.getElementById('empty-state');
            const grid = document.getElementById('items-grid');
            
            if (filteredItems.length === 0) {
                emptyState.style.display = 'block';
                grid.innerHTML = '';
            } else {
                emptyState.style.display = 'none';
                renderItems(filteredItems);
            }
        }, 300);

        // æ¸²æŸ“è®°å½•å¡ç‰‡
        function renderItems(items) {
            const grid = document.getElementById('items-grid');
            grid.innerHTML = '';
            
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                
                // å°é¢å›¾ç‰‡ï¼ˆä½¿ç”¨ç¬¬ä¸€å¼ å›¾ç‰‡ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºå ä½ç¬¦ï¼‰
                const coverImage = item.images && item.images.length > 0 
                    ? item.images[0].image_url 
                    : '/static/images/placeholder.svg';
                
                const hasImages = item.images && item.images.length > 0;
                const cardId = `item-card-${item.id}`;
                
                card.innerHTML = `
                    <div class="item-card-image" id="${cardId}" style="${hasImages ? 'cursor: pointer;' : ''}">
                        <img src="${coverImage}" alt="${item.title}" onerror="this.src='/static/images/placeholder.svg'">
                        <div class="item-card-category">${item.category_name}</div>
                        ${hasImages ? '<div class="item-card-view-hint">ç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡</div>' : ''}
                    </div>
                    <div class="item-card-content">
                        <h3 class="item-card-title">${item.title}</h3>
                        <div class="item-card-time">
                            <span class="time-icon">ğŸ“…</span>
                            ${formatDate(item.finish_time)}
                        </div>
                        ${item.notes ? `<p class="item-card-notes">${item.notes}</p>` : ''}
                        ${item.images && item.images.length > 1 ? `<div class="item-card-images-count">å…± ${item.images.length} å¼ å›¾ç‰‡</div>` : ''}
                    </div>
                    <div class="item-card-actions">
                        <button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id})">åˆ é™¤</button>
                    </div>
                `;
                
                grid.appendChild(card);
                
                // ä¸ºæœ‰å›¾ç‰‡çš„å¡ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
                if (hasImages) {
                    const imageElement = document.getElementById(cardId);
                    if (imageElement) {
                        imageElement.addEventListener('click', function() {
                            createImageViewer(item.images, 0);
                        });
                    }
                }
            });
        }

        // è®¾ç½®ç­›é€‰å™¨
        function setupFilters() {
            const categoryFilter = document.getElementById('category-filter');
            const yearFilter = document.getElementById('year-filter');
            const clearBtn = document.getElementById('clear-filters');
            
            // å¡«å……å¹´ä»½é€‰é¡¹
            const years = getYearOptions(2020);
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            // ç­›é€‰äº‹ä»¶
            categoryFilter.addEventListener('change', applyFilters);
            yearFilter.addEventListener('change', applyFilters);
            clearBtn.addEventListener('click', () => {
                categoryFilter.value = '';
                yearFilter.value = '';
                applyFilters();
            });
        }

        // åº”ç”¨ç­›é€‰
        function applyFilters() {
            const categoryId = document.getElementById('category-filter').value;
            const year = document.getElementById('year-filter').value;
            
            const params = {};
            if (categoryId) params.category_id = categoryId;
            if (year) params.year = parseInt(year);
            
            // æ¸…é™¤æœç´¢æ¡†
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            const searchClear = document.getElementById('search-clear');
            if (searchClear) searchClear.style.display = 'none';
            
            loadItems(params);
        }

        // åˆ é™¤è®°å½•
        async function deleteItem(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                await ItemsAPI.delete(id);
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                applyFilters(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
