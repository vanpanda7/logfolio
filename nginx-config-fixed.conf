server {
    listen 7878 ; 
    listen [::]:7878 ; 
    listen 7777 ; 
    listen [::]:7777 ; 
    server_name tongjun.asia tongjun.asia; 
    index index.php index.html index.htm default.php default.htm default.html; 
    access_log /www/sites/logfolio/log/access.log main; 
    error_log /www/sites/logfolio/log/error.log;
    
    # Gzip 压缩：减少 70% 传输体积
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml; 
    
    # 根目录指向前端文件
    root /www/sites/logfolio/index; 
    
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.env|\.svn|\.project|LICENSE|README.md) {
        return 404; 
    }
    location ^~ /.well-known/acme-challenge {
        allow all; 
        root /usr/share/nginx/html; 
    }
    
    error_page 404 /404.html; 
    
    # ----------------------------------------
    # /api/：从 Basic 认证解析用户，设置 X-User-ID 后转发到 FastAPI
    # 注意：这里需要 Basic 认证，所以 auth_basic 会在这里生效
    # ----------------------------------------
    location /api/ {
        # Basic 认证（从认证信息中提取用户名）
        auth_basic "Authentication"; 
        auth_basic_user_file /www/sites/logfolio/auth_basic/auth.pass; 
        
        # 初始化变量
        set $uid "default_user";
        
        # 在认证后使用 rewrite_by_lua_block 提取用户名（在 auth_basic 之后执行）
        rewrite_by_lua_block {
            local auth = ngx.var.http_authorization
            if not auth then
                auth = ngx.req.get_headers()["authorization"] or ngx.req.get_headers()["Authorization"]
            end
            if auth and auth:sub(1, 6) == "Basic " then
                local b64 = auth:sub(7)
                local ok, decoded = pcall(ngx.decode_base64, b64)
                if ok and decoded then
                    local user = decoded:match("^([^:]+)")
                    if user and user ~= "" then
                        ngx.var.uid = user
                    end
                end
            end
        }
        
        # 设置 X-User-ID 头传递给后端
        proxy_set_header X-User-ID $uid; 
        proxy_pass http://127.0.0.1:8000/api/;  # 注意：这里要加上 /api/，否则路径会重复
        proxy_set_header Host $host; 
        proxy_set_header X-Real-IP $remote_addr; 
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
        proxy_set_header X-Forwarded-Proto $scheme; 
        # 传递认证信息到后端（如果需要）
        proxy_set_header Authorization $http_authorization;
        
        # API 超时和连接优化
        proxy_connect_timeout 10s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        
        # 添加调试日志（可选，用于排查问题）
        # access_log /www/sites/logfolio/log/api_access.log main;
    }
    
    # ----------------------------------------
    # /static/：前端静态资源（CSS, JS, 图片等）
    # 不需要 Basic 认证，直接访问
    # 生产环境：强缓存 + 版本控制
    # ----------------------------------------
    location /static/ {
        alias /www/sites/logfolio/index/static/;
        
        # JS/CSS 文件：强缓存 1 年
        location ~* \.(js|css)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Cache-Status "HIT";
            access_log off;
        }
        
        # 图片资源：缓存 30 天
        location ~* \.(jpg|jpeg|png|gif|webp|svg|ico)$ {
            expires 30d;
            add_header Cache-Control "public";
            access_log off;
        }
        
        # 默认缓存
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Cache-Status "HIT";
        access_log off;
    }
    
    # ----------------------------------------
    # HTML 页面直接服务（不代理到后端）
    # 需要 Basic 认证
    # 注意：这个 location 必须在 location / 之前，因为 nginx 按最长匹配优先
    # 使用验证缓存（304），平衡更新速度和流量
    # ----------------------------------------
    location ~ \.(html|htm)$ {
        auth_basic "Authentication"; 
        auth_basic_user_file /www/sites/logfolio/auth_basic/auth.pass;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
        try_files $uri =404;
    }
    
    # ----------------------------------------
    # 明确拒绝旧的 manage-categories 路径（重定向到新路径）
    # ----------------------------------------
    location = /manage-categories {
        auth_basic "Authentication"; 
        auth_basic_user_file /www/sites/logfolio/auth_basic/auth.pass;
        return 301 /categories;
    }
    
    # ----------------------------------------
    # /：前端页面路由
    # 需要 Basic 认证才能访问（这样浏览器会记住认证信息，用于后续 API 请求）
    # 处理不带 .html 扩展名的路由（如 /todos -> todos.html）
    # 使用验证缓存（304），平衡更新速度和流量
    # ----------------------------------------
    location / {
        auth_basic "Authentication"; 
        auth_basic_user_file /www/sites/logfolio/auth_basic/auth.pass;
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
        # 先尝试直接访问文件，然后尝试添加 .html 扩展名，最后返回 index.html
        try_files $uri $uri.html $uri/ /index.html;
    }
    
    if ($request_method = 'OPTIONS' ) {
        return 204; 
    }
    
    real_ip_recursive on; 
    set_real_ip_from 127.0.0.1; 
    real_ip_header X-Real-IP; 
}
