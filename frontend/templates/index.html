<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Logfolio</title>
    <link rel="stylesheet" href="/static/css/style.css?v=20260127">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        window.API_BASE_URL = '/api';
    </script>
</head>
<body>
    <div class="header-container"></div>

    <div id="app">
        <main class="main">
            <div class="container">
                <!-- é¡¶éƒ¨æœç´¢æ¡† -->
                <div class="home-search-top">
                    <div class="search-wrapper">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" v-model.trim="searchTerm" class="search-input" placeholder="æœç´¢è®°å½•ï¼ˆæ ‡é¢˜ã€å¤‡æ³¨ï¼‰..." ref="searchInput">
                        <button type="button" class="search-clear" v-show="searchTerm" @click="searchTerm = ''">âœ•</button>
                    </div>
                </div>
                <!-- å·¥å…·æ ï¼šæœç´¢æ¡†ï¼ˆæ»šåŠ¨æ—¶æ˜¾ç¤ºï¼‰ -->
                <div class="toolbar" id="toolbar-container">
                    <div class="search-wrapper" id="search-wrapper" style="display: none;">
                        <span class="search-icon">ğŸ”</span>
                        <input type="text" v-model.trim="searchTerm" class="search-input" placeholder="æœç´¢è®°å½•..." ref="searchInput">
                        <button type="button" class="search-clear" v-show="searchTerm" @click="searchTerm = ''">âœ•</button>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ + å¹´ä»½ + åˆ†ç±»ç­›é€‰ -->
                <div class="home-stats">
                    <div class="home-stats-row">
                        <div class="home-stat-total">
                            <p class="home-stat-label">æ€»è®°å½•æ•°</p>
                            <div class="home-stat-value-wrap">
                                <span class="home-stat-value">{{ displayTotal }}</span>
                                <span class="home-stat-unit">æ¡ç›®</span>
                            </div>
                        </div>
                        <div class="home-year-wrap">
                            <template v-if="!selectedYear">
                                <button type="button" class="home-quick-add-btn" title="æœç´¢åç›´æ¥æ·»åŠ ä¸ºå†å²è®°å½•" @click="openQuickAdd">æ·»åŠ </button>
                                <button type="button" class="home-quick-add-btn home-batch-add-btn" title="æ¯è¡Œä¸€ä¸ªæ ‡é¢˜ï¼Œæ‰¹é‡åˆ›å»ºè®°å½•" @click="openBatchAdd">æ‰¹é‡æ·»åŠ </button>
                            </template>
                            <button type="button" class="home-year-btn" @click.stop="yearDropdownOpen = !yearDropdownOpen">
                                <span>{{ yearLabel }}</span>
                                <span class="home-year-chevron">â–¼</span>
                            </button>
                            <div class="home-year-dropdown" v-show="yearDropdownOpen" @click.stop>
                                <button type="button" v-for="y in yearOptions" :key="y" :class="['stat-year-item','home-year-option', { active: selectedYear === y }]" :data-year="y" @click="selectYear(y); yearDropdownOpen = false">{{ y === '' ? 'å…¨éƒ¨å¹´ä»½' : y }}</button>
                            </div>
                        </div>
                    </div>
                    <div class="home-chips">
                        <button type="button" v-for="chip in categoryChips" :key="chip.id" :class="['stat-category-item','home-chip', { active: selectedCategoryId === chip.id }]" :data-category-id="chip.id" @click="selectCategory(chip.id)">
                            <span>{{ chip.name }}</span>
                            <span class="home-chip-count">{{ chip.count }}</span>
                        </button>
                    </div>
                </div>

                <transition name="loading-fade">
                    <div v-show="loading || (searchTerm && searchLoading)" class="loading loading-with-animation">åŠ è½½ä¸­...</div>
                </transition>
                <div v-show="!loading && !(searchTerm && searchLoading) && filteredList.length === 0" class="empty-state">
                    <div class="empty-icon">ğŸ‚</div>
                    <p v-if="searchTerm">æœªæ‰¾åˆ°åŒ¹é…ã€Œ{{ searchTerm }}ã€çš„è®°å½•</p>
                    <p v-else>è¿™é‡Œè¿˜ä»€ä¹ˆéƒ½æ²¡æœ‰</p>
                    <a v-if="!searchTerm" href="/add" class="btn btn-primary">å»è®°å½•ä¸€ç¬”</a>
                </div>
                <transition name="grid-fade" mode="out-in">
                    <div v-show="!loading && !(searchTerm && searchLoading) && filteredList.length > 0" class="items-grid" key="grid">
                        <div v-for="item in filteredList" :key="item.id" class="item-card" @click="onCardClick($event, item)" @contextmenu.prevent="confirmDeleteItem(item)">
                            <div class="item-card-image">
                                <div class="item-badge">{{ item.category_name }}</div>
                                <div class="item-card-image-slot">
                                    <img :src="itemCover(item)" loading="lazy" :alt="item.title" @error="($event.target).src='/static/images/placeholder.svg'">
                                </div>
                                <div class="item-overlay">
                                    <h3 class="item-title">{{ item.title }}</h3>
                                    <div class="item-meta">
                                        <span v-if="item.finish_time">{{ formatDate(item.finish_time) }}</span>
                                        <span v-if="item.images && item.images.length > 1">{{ item.images.length }}</span>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="item-delete-btn" title="åˆ é™¤" @click.stop="confirmDeleteItem(item)">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                </transition>
                <div v-show="!loading && filteredList.length > 0 && hasMore" class="load-more-wrap">
                    <div class="load-more-inner" :class="{ pulling: !loadingMore, loading: loadingMore }">
                        <template v-if="loadingMore">
                            <span class="load-more-spinner"></span>
                            <span class="load-more-text">åŠ è½½ä¸­...</span>
                        </template>
                        <template v-else>
                            <span class="load-more-arrow">â†‘</span>
                            <span class="load-more-hint">ä¸Šæ‹‰åŠ è½½æ›´å¤š</span>
                        </template>
                    </div>
                </div>
            </div>
        </main>
        <!-- æ‰¹é‡æ·»åŠ å¼¹çª— -->
        <div v-show="batchAddOpen" class="batch-add-overlay" @click.self="closeBatchAdd">
            <div class="batch-add-dialog">
                <div class="batch-add-header">
                    <h3>æ‰¹é‡æ·»åŠ </h3>
                    <button type="button" class="batch-add-close" @click="closeBatchAdd">âœ•</button>
                </div>
                <p class="batch-add-hint">æ¯è¡Œä¸€ä¸ªæ ‡é¢˜ï¼Œå°†æ‰¹é‡åˆ›å»ºä¸ºå·²å®Œæˆè®°å½•ï¼ˆä¸å¡«å®Œæˆæ—¥æœŸï¼‰</p>
                <textarea v-model="batchAddText" class="batch-add-textarea" placeholder="é»‘æš—ä¹‹é­‚1&#10;é»‘æš—ä¹‹é­‚2&#10;è‰¾å°”ç™»æ³•ç¯&#10;åªç‹¼" rows="8"></textarea>
                <div class="batch-add-category">
                    <label>å½’å±åˆ†ç±»</label>
                    <select v-model="batchAddCategoryId" class="batch-add-select">
                        <option v-for="c in categories" :key="c.id" :value="c.id">{{ c.name }}</option>
                    </select>
                </div>
                <p v-if="batchAdding" class="batch-add-progress">å·²æ·»åŠ  {{ batchAddDone }} / {{ batchAddTotal }}</p>
                <div class="batch-add-actions">
                    <button type="button" class="btn btn-primary" :disabled="batchAdding || !batchAddText.trim() || !batchAddCategoryId" @click="submitBatchAdd">æ‰¹é‡åˆ›å»º</button>
                    <button type="button" class="btn btn-secondary" :disabled="batchAdding" @click="closeBatchAdd">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/api.js?v=20260127"></script>
    <script src="/static/js/cover-picker.js?v=20260127"></script>
    <script src="/static/js/app.js?v=20260127"></script>
    <script src="/static/js/components.js?v=20260127"></script>
    <script>
        const { createApp } = Vue;

        const indexApp = createApp({
            data() {
                return {
                    loading: false,
                    loadingMore: false,
                    items: [],
                    totalCount: 0,
                    hasMore: false,
                    categories: [],
                    selectedYear: String(new Date().getFullYear()),
                    selectedCategoryId: '',
                    searchTerm: '',
                    searchResults: [],
                    searchLoading: false,
                    searchDebounceTimer: null,
                    yearDropdownOpen: false,
                    availableYears: [],
                    PAGE_SIZE: 20,
                    PULL_TRIGGER_PX: 72,
                    batchAddOpen: false,
                    batchAddText: '',
                    batchAddCategoryId: '',
                    batchAdding: false,
                    batchAddDone: 0,
                    batchAddTotal: 0,
                    chipsTotal: 0,
                    chipsByCategory: {},
                };
            },
            computed: {
                yearLabel() {
                    return this.selectedYear === '' ? 'å…¨éƒ¨å¹´ä»½' : this.selectedYear;
                },
                yearOptions() {
                    const list = [''].concat(this.availableYears);
                    return list;
                },
                categoryChips() {
                    const list = [{ id: '', name: 'å…¨éƒ¨', count: this.chipsTotal }];
                    (this.categories || []).forEach(cat => {
                        list.push({
                            id: String(cat.id),
                            name: cat.name || '',
                            count: this.chipsByCategory[cat.name] ?? 0
                        });
                    });
                    return list;
                },
                statTotal() {
                    return this.totalCount;
                },
                displayTotal() {
                    if (this.searchTerm.trim()) return this.filteredList.length;
                    return this.statTotal;
                },
                filteredList() {
                    if (!this.searchTerm.trim()) return this.items;
                    return this.searchResults;
                }
            },
            methods: {
                formatDate(d) {
                    return typeof window.formatDate === 'function' ? window.formatDate(d) : (d || 'â€”');
                },
                itemCover(item) {
                    const url = (item.images && item.images.length > 0) ? item.images[0].image_url : '';
                    if (!url) return '/static/images/placeholder.svg';
                    if (url.startsWith('/api/uploads/')) return '/api/serve-webp/' + url.replace(/^\/api\/uploads\//, '');
                    return url;
                },
                buildParams() {
                    const p = {};
                    if (this.selectedYear) p.year = parseInt(this.selectedYear, 10);
                    if (this.selectedCategoryId) p.category_id = parseInt(this.selectedCategoryId, 10);
                    return p;
                },
                async loadCategories() {
                    try {
                        const list = await CategoriesAPI.getAll();
                        this.categories = list || [];
                        const temp = document.getElementById('category-filter-tabs');
                        if (!temp && this.categories.length) {
                            const div = document.createElement('div');
                            div.id = 'category-filter-tabs';
                            div.className = 'category-filter-tabs';
                            div.style.display = 'none';
                            document.body.appendChild(div);
                        }
                    } catch (e) {
                        if (typeof showMessage === 'function') showMessage('åŠ è½½åˆ†ç±»å¤±è´¥: ' + (e.message || ''), 'error');
                    }
                },
                async loadCategoryCounts() {
                    try {
                        const year = this.selectedYear ? parseInt(this.selectedYear, 10) : null;
                        const res = await ItemsAPI.getCategoryCounts(year);
                        this.chipsTotal = res.total ?? 0;
                        this.chipsByCategory = res.by_category || {};
                    } catch (e) {
                        this.chipsTotal = 0;
                        this.chipsByCategory = {};
                    }
                },
                async loadItems() {
                    this.loading = true;
                    try {
                        const params = { ...this.buildParams(), limit: this.PAGE_SIZE, offset: 0 };
                        const data = await ItemsAPI.getAll(params);
                        const list = Array.isArray(data) ? data : (data.items || []);
                        const total = Array.isArray(data) ? data.length : (data.total ?? 0);
                        this.items = list;
                        this.totalCount = total;
                        this.hasMore = this.items.length < this.totalCount;
                        let years = [];
                        try {
                            const res = await ItemsAPI.getAvailableYears();
                            years = (res.years || []).map(String);
                        } catch (e) {}
                        if (years.length === 0) years.push(String(new Date().getFullYear()));
                        this.availableYears = years;
                    } catch (error) {
                        if (typeof showMessage === 'function') showMessage('åŠ è½½è®°å½•å¤±è´¥: ' + (error.message || ''), 'error');
                    } finally {
                        this.loading = false;
                    }
                },
                async loadMore() {
                    if (this.loadingMore || !this.hasMore || this.searchTerm.trim()) return;
                    this.loadingMore = true;
                    try {
                        const params = { ...this.buildParams(), limit: this.PAGE_SIZE, offset: this.items.length };
                        const data = await ItemsAPI.getAll(params);
                        const list = Array.isArray(data) ? data : (data.items || []);
                        this.items = this.items.concat(list);
                        this.hasMore = this.items.length < this.totalCount;
                    } catch (error) {
                        if (typeof showMessage === 'function') showMessage('åŠ è½½æ›´å¤šå¤±è´¥: ' + (error.message || ''), 'error');
                    } finally {
                        this.loadingMore = false;
                    }
                },
                onScroll() {
                    if (this._scrollTimer) return;
                    this._scrollTimer = setTimeout(() => {
                        this._scrollTimer = null;
                        if (!this.hasMore || this.loadingMore || this.searchTerm.trim()) return;
                        const el = document.scrollingElement || document.documentElement;
                        const distanceToBottom = el.scrollHeight - el.scrollTop - el.clientHeight;
                        if (distanceToBottom <= this.PULL_TRIGGER_PX) this.loadMore();
                    }, 120);
                },
                async loadSearchResults() {
                    const term = this.searchTerm.trim();
                    if (!term) {
                        this.searchResults = [];
                        return;
                    }
                    this.searchLoading = true;
                    try {
                        const params = this.buildParams();
                        params.search = term;
                        const data = await ItemsAPI.getAll(params);
                        this.searchResults = Array.isArray(data) ? data : (data.items || []);
                    } catch (e) {
                        this.searchResults = [];
                        if (typeof showMessage === 'function') showMessage('æœç´¢å¤±è´¥: ' + (e.message || ''), 'error');
                    } finally {
                        this.searchLoading = false;
                    }
                },
                refreshList() {
                    this.loadCategoryCounts();
                    return this.loadItems();
                },
                selectYear(y) {
                    this.selectedYear = y === '' ? '' : String(y);
                    if (this.selectedYear === '' && this.selectedCategoryId === '' && this.categories.length) {
                        this.selectedCategoryId = String(this.categories[0].id);
                    }
                    this.searchTerm = '';
                    this.loadCategoryCounts();
                    this.loadItems();
                },
                selectCategory(id) {
                    this.selectedCategoryId = id || '';
                    this.searchTerm = '';
                    this.loadItems();
                },
                openQuickAdd() {
                    if (!this.categories.length) {
                        if (typeof showMessage === 'function') showMessage('è¯·å…ˆç­‰å¾…åˆ†ç±»åŠ è½½', 'error');
                        return;
                    }
                    const app = this;
                    CoverPicker.open({
                        mode: 'quickAdd',
                        categories: this.categories,
                        selectedCategoryId: this.selectedCategoryId,
                        onAdd(item, categoryId, title) {
                            const displayTitle = title || (item.title_japanese && item.title_japanese.trim()) || (item.title && item.title.trim()) || 'æœªå‘½å';
                            const coverUrl = (item && item.url) ? item.url.trim() : '';
                            const formData = new FormData();
                            formData.append('title', displayTitle);
                            formData.append('category_id', categoryId);
                            formData.append('is_completed', 'true');
                            formData.append('skip_finish_time', '1');
                            if (coverUrl) formData.append('cover_image_url', coverUrl);
                            ItemsAPI.create(formData).then(() => {
                                if (typeof showMessage === 'function') showMessage('å·²æ·»åŠ ', 'success');
                                app.refreshList();
                            }).catch(err => {
                                if (typeof showMessage === 'function') showMessage('æ·»åŠ å¤±è´¥: ' + (err.message || 'ç½‘ç»œé”™è¯¯'), 'error');
                            });
                        }
                    });
                },
                openBatchAdd() {
                    if (!this.categories.length) {
                        if (typeof showMessage === 'function') showMessage('è¯·å…ˆç­‰å¾…åˆ†ç±»åŠ è½½', 'error');
                        return;
                    }
                    this.batchAddText = '';
                    this.batchAddCategoryId = this.selectedCategoryId ? String(this.selectedCategoryId) : (this.categories[0] ? String(this.categories[0].id) : '');
                    this.batchAddOpen = true;
                    this.batchAdding = false;
                },
                closeBatchAdd() {
                    if (this.batchAdding) return;
                    this.batchAddOpen = false;
                },
                async submitBatchAdd() {
                    const lines = this.batchAddText.split(/\r?\n/).map(s => s.trim()).filter(s => s.length > 0);
                    if (lines.length === 0) {
                        if (typeof showMessage === 'function') showMessage('è¯·è‡³å°‘è¾“å…¥ä¸€è¡Œæ ‡é¢˜', 'error');
                        return;
                    }
                    const categoryId = this.batchAddCategoryId ? parseInt(this.batchAddCategoryId, 10) : (this.categories[0] && this.categories[0].id);
                    if (!categoryId) {
                        if (typeof showMessage === 'function') showMessage('è¯·é€‰æ‹©åˆ†ç±»', 'error');
                        return;
                    }
                    const cat = this.categories.find(c => c.id === categoryId);
                    const searchType = (cat && cat.name && cat.name.indexOf('æ¸¸æˆ') !== -1) ? 'game' : 'all';
                    this.batchAdding = true;
                    this.batchAddTotal = lines.length;
                    this.batchAddDone = 0;
                    let ok = 0;
                    for (let i = 0; i < lines.length; i++) {
                        try {
                            let coverUrl = '';
                            try {
                                const res = await CoverSearchAPI.search(lines[i], searchType, 'bangumi');
                                const list = res && res.data ? res.data : [];
                                if (list.length > 0 && list[0].url) coverUrl = list[0].url.trim();
                            } catch (_) {}
                            const formData = new FormData();
                            formData.append('title', lines[i]);
                            formData.append('category_id', categoryId);
                            formData.append('is_completed', 'true');
                            formData.append('skip_finish_time', '1');
                            if (coverUrl) formData.append('cover_image_url', coverUrl);
                            await ItemsAPI.create(formData);
                            ok++;
                        } catch (e) {
                            if (typeof showMessage === 'function') showMessage('ç¬¬ ' + (i + 1) + ' æ¡æ·»åŠ å¤±è´¥: ' + (e.message || ''), 'error');
                        }
                        this.batchAddDone = i + 1;
                        if (i < lines.length - 1) await new Promise(r => setTimeout(r, 250));
                    }
                    this.batchAdding = false;
                    if (typeof showMessage === 'function') showMessage('å·²æ·»åŠ  ' + ok + ' æ¡', ok > 0 ? 'success' : 'info');
                    this.batchAddOpen = false;
                    this.refreshList();
                },
                onCardClick(e, item) {
                    if (e.target.closest('.item-delete-btn')) return;
                    showItemDetail(item);
                },
                confirmDeleteItem(item) {
                    showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', () => { deleteItem(item.id); });
                }
            },
            watch: {
                searchTerm(newVal) {
                    if (this.searchDebounceTimer) clearTimeout(this.searchDebounceTimer);
                    if (!(newVal && newVal.trim())) {
                        this.searchResults = [];
                        return;
                    }
                    this.searchDebounceTimer = setTimeout(() => {
                        this.searchDebounceTimer = null;
                        this.loadSearchResults();
                    }, 300);
                }
            },
            mounted() {
                document.body.style.overflow = '';
                document.addEventListener('click', () => { this.yearDropdownOpen = false; });
                window.addEventListener('scroll', this.onScroll, { passive: true });
            },
            beforeUnmount() {
                window.removeEventListener('scroll', this.onScroll);
            }
        });

        const root = indexApp.mount('#app');
        window.indexApp = root;

        async function init() {
            try {
                if (typeof window.renderHeader === 'function') window.renderHeader('index');
                await root.loadCategories();
                await root.loadCategoryCounts();
                await root.loadItems();
                setupScrollSearch();
                const urlParams = new URLSearchParams(window.location.search);
                const openItemId = urlParams.get('item_id');
                const shouldEdit = urlParams.get('edit');
                if (openItemId) {
                    try {
                        const item = await ItemsAPI.getById(openItemId);
                        if (item) {
                            showItemDetail(item);
                            if (shouldEdit === '1') {
                                setTimeout(function() {
                                    var overlay = document.querySelector('.item-detail-overlay');
                                    if (overlay) openEditItemForm(overlay);
                                }, 100);
                            }
                        }
                    } catch (e) {
                        if (typeof showMessage === 'function') showMessage('æœªæ‰¾åˆ°è¯¥è®°å½•', 'error');
                    }
                    if (window.history.replaceState) {
                        window.history.replaceState({}, '', window.location.pathname);
                    }
                }
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                let msg = 'é¡µé¢åŠ è½½å¤±è´¥: ' + (error.message || '');
                if (error.status === 401) msg = 'è®¤è¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢å¹¶é‡æ–°ç™»å½•';
                if (typeof showMessage === 'function') showMessage(msg, 'error');
            }
        }

        function setupScrollSearch() {
            const searchWrapper = document.getElementById('search-wrapper');
            if (!searchWrapper) return;
            let lastScrollTop = 0;
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                clearTimeout(scrollTimeout);
                if (scrollTop > 100 && scrollTop > lastScrollTop) {
                    searchWrapper.style.display = 'block';
                    searchWrapper.style.opacity = '0';
                    setTimeout(() => {
                        searchWrapper.style.transition = 'opacity 0.3s';
                        searchWrapper.style.opacity = '1';
                    }, 10);
                }
                if (scrollTop < 50) {
                    searchWrapper.style.opacity = '0';
                    scrollTimeout = setTimeout(() => { searchWrapper.style.display = 'none'; }, 300);
                }
                lastScrollTop = scrollTop;
            });
        }

        // è®¾ç½®ç­›é€‰å™¨
        async function setupFilters() {
            // åˆ›å»ºå¹´ä»½é€‰æ‹©å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let yearFilter = document.getElementById('year-filter');
            if (!yearFilter) {
                yearFilter = document.createElement('select');
                yearFilter.id = 'year-filter';
                yearFilter.className = 'filter-select';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'å…¨éƒ¨å¹´ä»½';
                yearFilter.appendChild(defaultOption);
                document.body.appendChild(yearFilter);
                yearFilter.style.display = 'none';
            }
            
            // ä»APIè·å–æœ‰è®°å½•çš„å¹´ä»½
            try {
                const response = await ItemsAPI.getAvailableYears();
                const years = response.years || [];
                const currentYear = new Date().getFullYear();
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªï¼‰
                while (yearFilter.children.length > 1) {
                    yearFilter.removeChild(yearFilter.lastChild);
                }
                
                // å¦‚æœæœ‰è®°å½•çš„å¹´ä»½åˆ—è¡¨ä¸ºç©ºï¼Œä½¿ç”¨å½“å‰å¹´
                if (years.length === 0) {
                    years.push(currentYear);
                }
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    // è®¾ç½®å½“å‰å¹´ä¸ºé»˜è®¤é€‰ä¸­ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearFilter.appendChild(option);
                });
                
                // å¦‚æœæ²¡æœ‰å½“å‰å¹´ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¹´ä»½
                if (!yearFilter.value && years.length > 0) {
                    yearFilter.value = years[0];
                }
            } catch (error) {
                console.error('è·å–å¹´ä»½åˆ—è¡¨å¤±è´¥:', error);
                // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å¹´ä»½åˆ—è¡¨
                const years = getYearOptions(2020);
                const currentYear = new Date().getFullYear();
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearFilter.appendChild(option);
                });
            }
            
            // è®¾ç½®æ»šåŠ¨ç›‘å¬ï¼Œæ˜¾ç¤ºæœç´¢æ¡†
            setupScrollSearch();
        }
        
        // è®¾ç½®ç­›é€‰å™¨äº‹ä»¶ï¼ˆåœ¨ç»Ÿè®¡å¡ç‰‡å†…éƒ¨ï¼‰
        window.setupFilterEvents = function() {
            // ç»‘å®šåˆ†ç±»tabsäº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
            const categoryTabsInner = document.getElementById('category-filter-tabs-inner');
            if (categoryTabsInner) {
                categoryTabsInner.addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-filter-tab')) {
                        // åŒæ­¥æ›´æ–°éšè—çš„åŸå§‹tabs
                        const originalTabs = document.getElementById('category-filter-tabs');
                        if (originalTabs) {
                            originalTabs.querySelectorAll('.category-filter-tab').forEach(t => {
                                t.classList.remove('active');
                                if (t.dataset.categoryId === e.target.dataset.categoryId) {
                                    t.classList.add('active');
                                }
                            });
                        }
                        
                        // ç§»é™¤æ‰€æœ‰ tab çš„ active çŠ¶æ€
                        document.querySelectorAll('.category-filter-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        // æ·»åŠ å½“å‰ tab çš„ active çŠ¶æ€
                        e.target.classList.add('active');
                        
                        // åº”ç”¨ç­›é€‰
                        applyFilters();
                    }
                });
            }
            
            // ç»‘å®šå¹´ä»½é€‰æ‹©å™¨äº‹ä»¶
            const yearFilterInner = document.getElementById('year-filter-inner');
            if (yearFilterInner) {
                yearFilterInner.addEventListener('change', function() {
                    // åŒæ­¥æ›´æ–°åŸå§‹çš„å¹´ä»½é€‰æ‹©å™¨
                    const originalYearFilter = document.getElementById('year-filter');
                    if (originalYearFilter && originalYearFilter !== yearFilterInner) {
                        originalYearFilter.value = this.value;
                    }
                    applyFilters();
                });
            }
        };
        
        // è®¾ç½®æ»šåŠ¨ç›‘å¬ï¼Œå½“ç”¨æˆ·æ»šåŠ¨æ—¶æ˜¾ç¤ºæœç´¢æ¡†
        function setupScrollSearch() {
            const searchWrapper = document.getElementById('search-wrapper');
            let lastScrollTop = 0;
            let scrollTimeout;
            
            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                clearTimeout(scrollTimeout);
                
                // å¦‚æœå‘ä¸‹æ»šåŠ¨è¶…è¿‡ 100pxï¼Œæ˜¾ç¤ºæœç´¢æ¡†
                if (scrollTop > 100 && scrollTop > lastScrollTop) {
                    searchWrapper.style.display = 'block';
                    searchWrapper.style.opacity = '0';
                    setTimeout(() => {
                        searchWrapper.style.transition = 'opacity 0.3s';
                        searchWrapper.style.opacity = '1';
                    }, 10);
                }
                
                // å¦‚æœæ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œéšè—æœç´¢æ¡†
                if (scrollTop < 50) {
                    searchWrapper.style.opacity = '0';
                    scrollTimeout = setTimeout(() => {
                        searchWrapper.style.display = 'none';
                    }, 300);
                }
                
                lastScrollTop = scrollTop;
            });
        }

        // å…¼å®¹ï¼šå¤–éƒ¨æˆ–æ—§é€»è¾‘è°ƒç”¨æ—¶å§”æ‰˜ç»™ Vue
        window.filterByCategory = function(categoryId) {
            if (window.indexApp) {
                window.indexApp.selectedCategoryId = categoryId ? String(categoryId) : '';
                window.indexApp.searchTerm = '';
                window.indexApp.loadItems();
            }
        };
        window.filterByYear = function(year) {
            if (window.indexApp) {
                window.indexApp.selectedYear = year ? String(year) : '';
                window.indexApp.searchTerm = '';
                window.indexApp.loadItems();
            }
        };
        
        // åº”ç”¨ç­›é€‰ï¼šåˆ·æ–° Vue åˆ—è¡¨ï¼ˆè¯¦æƒ…å†…æ·»åŠ /åˆ é™¤å›¾ç‰‡ã€åˆ é™¤è®°å½•ç­‰åè°ƒç”¨ï¼‰
        function applyFilters() {
            if (window.indexApp && typeof window.indexApp.refreshList === 'function') window.indexApp.refreshList();
        }

        // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
        function showItemDetail(item) {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'item-detail-overlay';
            
            // åˆ›å»ºè¯¦æƒ…å¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.className = 'item-detail-dialog';
            
            // æ„å»ºå›¾ç‰‡ç½‘æ ¼
            let imagesHTML = '';
            if (item.images && item.images.length > 0) {
                imagesHTML = `
                    <div class="item-detail-images" id="item-detail-images-${item.id}">
                        ${item.images.map((img, idx) => `
                            <div class="item-detail-image-item" data-image-id="${img.id}">
                                <img src="${img.image_url}" alt="å›¾ç‰‡ ${idx + 1}">
                                <button class="item-image-delete" onclick="deleteImageFromDetail(${img.id}, ${item.id}, this.closest('.item-detail-overlay'))" title="åˆ é™¤å›¾ç‰‡">âœ•</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                imagesHTML = `<div class="item-detail-images" id="item-detail-images-${item.id}"></div>`;
            }
            
            const editTitleValue = (item.title || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/"/g, '&quot;');
            const editDateValue = item.finish_time ? item.finish_time.slice(0, 10) : '';
            dialog.innerHTML = `
                <div class="item-detail-content">
                    <button class="item-detail-close" onclick="closeDetailDialog(this.closest('.item-detail-overlay'))">âœ•</button>
                    <div class="item-detail-header">
                        <div class="item-detail-badge">${item.category_name}</div>
                        <div class="item-detail-view">
                            <h2 class="item-detail-title">${item.title}</h2>
                            <div class="item-detail-date">
                                <span class="date-icon">ğŸ“…</span>
                                ${formatDate(item.finish_time)}
                            </div>
                        </div>
                        <div class="item-detail-edit" style="display:none;" data-item-id="${item.id}">
                            <label class="item-detail-edit-label">æ ‡é¢˜</label>
                            <input type="text" class="item-detail-edit-title" value="${editTitleValue}" placeholder="æ ‡é¢˜">
                            <label class="item-detail-edit-label">å®Œæˆæ—¶é—´</label>
                            <input type="date" class="item-detail-edit-finish" value="${editDateValue}">
                            <label class="item-detail-edit-no-date"><input type="checkbox" class="item-detail-edit-no-date-cb" onchange="var d=this.closest('.item-detail-edit').querySelector('.item-detail-edit-finish');if(d)d.disabled=this.checked"> ä¸å¡«å®Œæˆæ—¥æœŸ</label>
                            <div class="item-detail-edit-actions">
                                <button type="button" class="btn btn-primary btn-sm" onclick="saveEditItem(${item.id}, this.closest('.item-detail-overlay'))">ä¿å­˜</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="cancelEditItem(this.closest('.item-detail-overlay'))">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                    ${item.notes ? `
                        <div class="item-detail-notes">
                            <h3>å¤‡æ³¨/æ„Ÿæƒ³</h3>
                            <p>${item.notes}</p>
                        </div>
                    ` : ''}
                    <div class="item-detail-images-section">
                        <div class="item-detail-images-header">
                            <h3>å›¾ç‰‡</h3>
                            <label class="btn btn-secondary btn-sm" style="margin: 0;">
                                æ·»åŠ å›¾ç‰‡
                                <input type="file" 
                                       id="add-images-${item.id}" 
                                       multiple 
                                       accept="image/*" 
                                       style="display: none;"
                                       onchange="handleAddImages(${item.id}, this.closest('.item-detail-overlay'))">
                            </label>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openDetailCoverPicker(${item.id}, this.closest('.item-detail-overlay'))">æœç´¢å°é¢</button>
                        </div>
                        ${imagesHTML}
                    </div>
                    <div class="item-detail-actions">
                        <button type="button" class="btn btn-secondary" onclick="openEditItemForm(this.closest('.item-detail-overlay'))">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteItemFromDetail(${item.id}, this.closest('.item-detail-overlay'))">åˆ é™¤è®°å½•</button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // å­˜å‚¨å½“å‰itemæ•°æ®åˆ°overlayï¼Œæ–¹ä¾¿åç»­æ›´æ–°
            overlay.dataset.itemId = item.id;
            overlay.dataset.currentImages = JSON.stringify(item.images || []);
            overlay.dataset.categoryName = item.category_name || '';
            overlay.dataset.finishTime = item.finish_time || '';
            
            // ä¸ºå›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæŸ¥çœ‹å¤§å›¾ï¼‰
            const imageItems = dialog.querySelectorAll('.item-detail-image-item');
            imageItems.forEach((itemEl, idx) => {
                const img = itemEl.querySelector('img');
                if (img) {
                    img.addEventListener('click', (e) => {
                        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯åˆ é™¤æŒ‰é’®ï¼Œåˆ™æŸ¥çœ‹å¤§å›¾
                        if (!e.target.closest('.item-image-delete')) {
                            const currentImages = JSON.parse(overlay.dataset.currentImages);
                            createImageViewer(currentImages, idx);
                        }
                    });
                }
            });
            
            // æ·»åŠ åŠ¨ç”»
            setTimeout(() => {
                overlay.classList.add('show');
            }, 10);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDetailDialog(overlay);
                }
            });
            
            // ESC é”®å…³é—­
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeDetailDialog(overlay);
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // è¯¦æƒ…å¼¹çª—å†…ã€Œæœç´¢å°é¢ã€ï¼šç”¨ CoverPicker é€‰å›¾åè°ƒç”¨æ¥å£å¹¶åˆ·æ–°åˆ—è¡¨
        function openDetailCoverPicker(itemId, overlay) {
            var titleEl = overlay.querySelector('.item-detail-title');
            var initialSearch = titleEl ? titleEl.textContent.trim() : '';
            var categoryName = overlay.dataset.categoryName || '';
            var searchType = (categoryName.indexOf('æ¸¸æˆ') !== -1) ? 'game' : 'both';
            CoverPicker.open({
                initialSearch: initialSearch,
                searchType: searchType,
                onSelect: function(coverUrl) {
                    ItemsAPI.addCoverFromUrl(itemId, coverUrl).then(function(newImages) {
                        // æ¥å£è¿”å›è¯¥æ¡ç›®çš„å®Œæ•´å›¾ç‰‡åˆ—è¡¨ï¼ˆæ–°å°é¢å·²æ’åœ¨æœ€å‰ï¼‰ï¼Œç›´æ¥æ›¿æ¢
                        overlay.dataset.currentImages = JSON.stringify(newImages);
                        refreshDetailImages(overlay, itemId, newImages);
                        if (typeof showMessage === 'function') showMessage('å°é¢å·²æ·»åŠ ', 'success');
                    }).catch(function(err) {
                        if (typeof showMessage === 'function') showMessage('æ·»åŠ å¤±è´¥: ' + err.message, 'error');
                    });
                }
            });
        }
        window.openDetailCoverPicker = openDetailCoverPicker;

        // åˆ·æ–°è¯¦æƒ…å¼¹çª—å†…çš„å›¾ç‰‡ç½‘æ ¼ï¼ˆæ·»åŠ å›¾ç‰‡ / æœç´¢å°é¢ åå…±ç”¨ï¼‰
        function refreshDetailImages(overlay, itemId, existingImages) {
            var imagesContainer = overlay.querySelector('#item-detail-images-' + itemId);
            if (!imagesContainer) return;
            imagesContainer.innerHTML = existingImages.map(function(img, idx) {
                return '<div class="item-detail-image-item" data-image-id="' + img.id + '">' +
                    '<img src="' + img.image_url + '" alt="å›¾ç‰‡ ' + (idx + 1) + '">' +
                    '<button class="item-image-delete" onclick="deleteImageFromDetail(' + img.id + ',' + itemId + ', this.closest(\'.item-detail-overlay\'))" title="åˆ é™¤å›¾ç‰‡">âœ•</button></div>';
            }).join('');
            imagesContainer.querySelectorAll('.item-detail-image-item').forEach(function(itemEl, idx) {
                var img = itemEl.querySelector('img');
                if (img) img.addEventListener('click', function(e) {
                    if (!e.target.closest('.item-image-delete')) createImageViewer(existingImages, idx);
                });
            });
        }

        // å¤„ç†æ·»åŠ å›¾ç‰‡
        async function handleAddImages(itemId, overlay) {
            const fileInput = document.getElementById(`add-images-${itemId}`);
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                return;
            }
            
            try {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }
                
                const newImages = await ItemsAPI.addImages(itemId, formData);
                
                var currentImages = JSON.parse(overlay.dataset.currentImages || '[]');
                currentImages.push.apply(currentImages, newImages);
                overlay.dataset.currentImages = JSON.stringify(currentImages);
                
                refreshDetailImages(overlay, itemId, currentImages);
                showMessage('å›¾ç‰‡æ·»åŠ æˆåŠŸ', 'success');
                fileInput.value = '';
                applyFilters();
            } catch (error) {
                showMessage('æ·»åŠ å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤å›¾ç‰‡
        async function deleteImageFromDetail(imageId, itemId, overlay) {
            showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ', async () => {
                try {
                    await ItemsAPI.deleteImage(imageId);
                    
                    // æ›´æ–°overlayä¸­çš„å›¾ç‰‡æ•°æ®
                    const currentImages = JSON.parse(overlay.dataset.currentImages || '[]');
                    const updatedImages = currentImages.filter(img => img.id !== imageId);
                    overlay.dataset.currentImages = JSON.stringify(updatedImages);
                    
                    // é‡æ–°æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
                    const imagesContainer = overlay.querySelector(`#item-detail-images-${itemId}`);
                    
                    if (updatedImages.length === 0) {
                        imagesContainer.innerHTML = '';
                    } else {
                        imagesContainer.innerHTML = updatedImages.map((img, idx) => `
                            <div class="item-detail-image-item" data-image-id="${img.id}">
                                <img src="${img.image_url}" alt="å›¾ç‰‡ ${idx + 1}">
                                <button class="item-image-delete" onclick="deleteImageFromDetail(${img.id}, ${itemId}, this.closest('.item-detail-overlay'))" title="åˆ é™¤å›¾ç‰‡">âœ•</button>
                            </div>
                        `).join('');
                        
                        // é‡æ–°ç»‘å®šå›¾ç‰‡ç‚¹å‡»äº‹ä»¶
                        const imageItems = imagesContainer.querySelectorAll('.item-detail-image-item');
                        imageItems.forEach((itemEl, idx) => {
                            const img = itemEl.querySelector('img');
                            if (img) {
                                img.addEventListener('click', (e) => {
                                    if (!e.target.closest('.item-image-delete')) {
                                        createImageViewer(updatedImages, idx);
                                    }
                                });
                            }
                        });
                    }
                    
                    showMessage('å›¾ç‰‡åˆ é™¤æˆåŠŸ', 'success');
                    
                    // åˆ·æ–°åˆ—è¡¨
                    applyFilters();
                } catch (error) {
                    showMessage('åˆ é™¤å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
                }
            });
        }
        
        // å…³é—­è¯¦æƒ…å¯¹è¯æ¡†
        function closeDetailDialog(overlay) {
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }
        
        // æ‰“å¼€ç¼–è¾‘ï¼šæ˜¾ç¤ºç¼–è¾‘è¡¨å•ï¼Œéšè—æ ‡é¢˜/æ—¥æœŸå±•ç¤º
        function openEditItemForm(overlay) {
            const view = overlay.querySelector('.item-detail-view');
            const edit = overlay.querySelector('.item-detail-edit');
            if (!view || !edit) return;
            const noDateCb = edit.querySelector('.item-detail-edit-no-date-cb');
            const dateInput = edit.querySelector('.item-detail-edit-finish');
            if (noDateCb) noDateCb.checked = !overlay.dataset.finishTime;
            if (dateInput) dateInput.disabled = noDateCb && noDateCb.checked;
            view.style.display = 'none';
            edit.style.display = 'block';
            edit.querySelector('.item-detail-edit-title').focus();
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEditItem(overlay) {
            const view = overlay.querySelector('.item-detail-view');
            const edit = overlay.querySelector('.item-detail-edit');
            if (view) view.style.display = '';
            if (edit) edit.style.display = 'none';
        }

        // ä¿å­˜ç¼–è¾‘ï¼ˆæ ‡é¢˜ã€å®Œæˆæ—¶é—´ï¼‰
        async function saveEditItem(itemId, overlay) {
            const edit = overlay.querySelector('.item-detail-edit');
            if (!edit) return;
            const titleInput = edit.querySelector('.item-detail-edit-title');
            const dateInput = edit.querySelector('.item-detail-edit-finish');
            const noDateCb = edit.querySelector('.item-detail-edit-no-date-cb');
            const title = (titleInput && titleInput.value) ? titleInput.value.trim() : '';
            if (!title) {
                if (typeof showMessage === 'function') showMessage('è¯·è¾“å…¥æ ‡é¢˜', 'error');
                return;
            }
            const formData = new FormData();
            formData.append('title', title);
            if (noDateCb && noDateCb.checked) {
                formData.append('finish_time', '');
            } else if (dateInput && dateInput.value) {
                formData.append('finish_time', dateInput.value);
            }
            try {
                await ItemsAPI.update(itemId, formData);
                if (typeof showMessage === 'function') showMessage('å·²ä¿å­˜', 'success');
                const view = overlay.querySelector('.item-detail-view');
                const titleEl = overlay.querySelector('.item-detail-title');
                const dateEl = overlay.querySelector('.item-detail-date');
                if (titleEl) titleEl.textContent = title;
                const newDate = (noDateCb && noDateCb.checked) ? '' : (dateInput && dateInput.value ? dateInput.value : '');
                overlay.dataset.finishTime = newDate ? (newDate + 'T00:00:00') : '';
                if (dateEl) dateEl.innerHTML = '<span class="date-icon">ğŸ“…</span> ' + (typeof formatDate === 'function' ? formatDate(overlay.dataset.finishTime || null) : (overlay.dataset.finishTime || 'â€”'));
                cancelEditItem(overlay);
                applyFilters();
            } catch (e) {
                if (typeof showMessage === 'function') showMessage('ä¿å­˜å¤±è´¥: ' + (e.message || ''), 'error');
            }
        }

        // ä»è¯¦æƒ…å¯¹è¯æ¡†åˆ é™¤è®°å½•
        async function deleteItemFromDetail(id, overlay) {
            showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', async () => {
                try {
                    await ItemsAPI.delete(id);
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    closeDetailDialog(overlay);
                    applyFilters();
                } catch (error) {
                    showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            });
        }
        
        // åˆ é™¤è®°å½•
        async function deleteItem(id) {
            try {
                await ItemsAPI.delete(id);
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                applyFilters();
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½ï¼ˆæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½ï¼‰
        let pullToRefresh = {
            startY: 0,
            currentY: 0,
            isPulling: false,
            threshold: 80, // ä¸‹æ‹‰é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
            refreshElement: null,
            
            init: function() {
                this.refreshElement = document.getElementById('pull-to-refresh');
                if (!this.refreshElement) return;
                
                // ç›‘å¬è§¦æ‘¸äº‹ä»¶
                document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
                document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
            },
            
            handleTouchStart: function(e) {
                // æ’é™¤é“¾æ¥ã€æŒ‰é’®å’Œ header åŒºåŸŸ
                const target = e.target;
                if (target.closest('a') || target.closest('button') || target.closest('header')) {
                    this.isPulling = false;
                    return;
                }
                
                // åªåœ¨é¡µé¢é¡¶éƒ¨ä¸”å‘ä¸‹æ»šåŠ¨æ—¶è§¦å‘
                if (window.scrollY === 0) {
                    this.startY = e.touches[0].clientY;
                    this.isPulling = true;
                }
            },
            
            handleTouchMove: function(e) {
                // æ’é™¤é“¾æ¥ã€æŒ‰é’®å’Œ header åŒºåŸŸ
                const target = e.target;
                if (target.closest('a') || target.closest('button') || target.closest('header')) {
                    this.isPulling = false;
                    this.resetUI();
                    return;
                }
                
                if (!this.isPulling) return;
                
                this.currentY = e.touches[0].clientY;
                const deltaY = this.currentY - this.startY;
                
                // åªåœ¨ä¸‹æ‹‰æ—¶è§¦å‘
                if (deltaY > 0 && window.scrollY === 0) {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨
                    
                    const progress = Math.min(deltaY / this.threshold, 1);
                    this.updateUI(progress, deltaY);
                } else {
                    this.resetUI();
                }
            },
            
            handleTouchEnd: function(e) {
                // æ’é™¤é“¾æ¥ã€æŒ‰é’®å’Œ header åŒºåŸŸ
                const target = e.target;
                if (target.closest('a') || target.closest('button') || target.closest('header')) {
                    this.isPulling = false;
                    this.resetUI();
                    return;
                }
                
                if (!this.isPulling) return;
                
                const deltaY = this.currentY - this.startY;
                
                if (deltaY >= this.threshold) {
                    // è§¦å‘åˆ·æ–°
                    this.triggerRefresh();
                } else {
                    // é‡ç½®
                    this.resetUI();
                }
                
                this.isPulling = false;
            },
            
            updateUI: function(progress, deltaY) {
                if (!this.refreshElement) return;
                
                this.refreshElement.style.display = 'flex';
                this.refreshElement.style.opacity = progress;
                this.refreshElement.style.transform = `translateY(${Math.min(deltaY, this.threshold)}px)`;
                
                if (deltaY >= this.threshold) {
                    this.refreshElement.querySelector('.pull-to-refresh-text').textContent = 'é‡Šæ”¾ä»¥æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°';
                    this.refreshElement.querySelector('.pull-to-refresh-icon').textContent = 'â¬†ï¸';
                } else {
                    this.refreshElement.querySelector('.pull-to-refresh-text').textContent = 'ä¸‹æ‹‰åˆ·æ–°å¹¶æ¸…é™¤ç¼“å­˜';
                    this.refreshElement.querySelector('.pull-to-refresh-icon').textContent = 'â¬‡ï¸';
                }
            },
            
            resetUI: function() {
                if (!this.refreshElement) return;
                
                this.refreshElement.style.display = 'none';
                this.refreshElement.style.opacity = '0';
                this.refreshElement.style.transform = 'translateY(0)';
            },
            
            triggerRefresh: async function() {
                if (!this.refreshElement) return;
                
                this.refreshElement.querySelector('.pull-to-refresh-text').textContent = 'æ­£åœ¨æ¸…é™¤ç¼“å­˜...';
                this.refreshElement.querySelector('.pull-to-refresh-icon').textContent = 'ğŸ”„';
                
                try {
                    // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
                    this.clearAllCache();
                    
                    // æ˜¾ç¤ºæç¤º
                    showMessage('ç¼“å­˜å·²æ¸…é™¤ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...', 'success');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await this.reloadData();
                    
                    // é‡ç½®UI
                    setTimeout(() => {
                        this.resetUI();
                        showMessage('åˆ·æ–°å®Œæˆï¼', 'success');
                    }, 500);
                    
                } catch (error) {
                    console.error('åˆ·æ–°å¤±è´¥:', error);
                    showMessage('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
                    this.resetUI();
                }
            },
            
            clearAllCache: function() {
                // æ¸…é™¤ localStorage
                try {
                    localStorage.clear();
                    console.log('å·²æ¸…é™¤ localStorage');
                } catch (e) {
                    console.warn('æ¸…é™¤ localStorage å¤±è´¥:', e);
                }
                
                // æ¸…é™¤ sessionStorage
                try {
                    sessionStorage.clear();
                    console.log('å·²æ¸…é™¤ sessionStorage');
                } catch (e) {
                    console.warn('æ¸…é™¤ sessionStorage å¤±è´¥:', e);
                }
                
                // æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼ˆé€šè¿‡æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶é‡æ–°åŠ è½½èµ„æºï¼‰
                const links = document.querySelectorAll('link[rel="stylesheet"]');
                links.forEach(link => {
                    if (link.href) {
                        const url = new URL(link.href);
                        url.searchParams.set('_t', Date.now());
                        link.href = url.toString();
                    }
                });
                
                // æ¸…é™¤å›¾ç‰‡ç¼“å­˜ï¼ˆé€šè¿‡æ·»åŠ æ—¶é—´æˆ³ï¼‰
                const images = document.querySelectorAll('img');
                images.forEach(img => {
                    if (img.src && !img.src.includes('data:')) {
                        const url = new URL(img.src);
                        url.searchParams.set('_t', Date.now());
                        img.src = url.toString();
                    }
                });
                
                console.log('å·²æ¸…é™¤æ‰€æœ‰ç¼“å­˜');
            },
            
            reloadData: async function() {
                if (window.indexApp) {
                    await window.indexApp.loadCategories();
                    await window.indexApp.loadItems();
                }
            }
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            init();
            pullToRefresh.init();
        });
    </script>
</body>
</html>
