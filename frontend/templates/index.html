<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Logfolio</title>
    <link rel="stylesheet" href="/static/css/style.css?v=20260127">
    <script>
        window.API_BASE_URL = '/api';
    </script>
</head>
<body>
    <div class="header-container"></div>

    <main class="main">
        <div class="container">
            <!-- å·¥å…·æ ï¼šæœç´¢æ¡†ï¼ˆæ»šåŠ¨æ—¶æ˜¾ç¤ºï¼‰ -->
            <div class="toolbar" id="toolbar-container">
                <div class="search-wrapper" id="search-wrapper" style="display: none;">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="search-input" class="search-input" placeholder="æœç´¢è®°å½•...">
                    <button id="search-clear" class="search-clear" style="display: none;">âœ•</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡ + å¹´ä»½ + åˆ†ç±»ç­›é€‰ï¼ˆä¿ç•™æ–°è®¾è®¡ï¼‰ -->
            <div id="statistics" class="home-stats">
                <div class="home-stats-row">
                    <div class="home-stat-total">
                        <p class="home-stat-label">æ€»è®°å½•æ•°</p>
                        <div class="home-stat-value-wrap">
                            <span id="stat-total" class="home-stat-value">0</span>
                            <span class="home-stat-unit">æ¡ç›®</span>
                        </div>
                    </div>
                    <div class="home-year-wrap">
                        <button type="button" id="year-dropdown-btn" class="home-year-btn">
                            <span id="year-dropdown-label">2026</span>
                            <span class="home-year-chevron">â–¼</span>
                        </button>
                        <div id="year-dropdown" class="home-year-dropdown" style="display: none;">
                            <!-- å¹´ä»½é€‰é¡¹ç”± JS å¡«å…… -->
                        </div>
                    </div>
                </div>
                <div id="filter-chips" class="home-chips">
                    <!-- ç”± JS å¡«å…… -->
                </div>
            </div>

            <!-- åŠ è½½æç¤º -->
            <div id="loading" class="loading" style="display: none;">åŠ è½½ä¸­...</div>
            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" class="empty-state" style="display: none;">
                <div class="empty-icon">ğŸ‚</div>
                <p>è¿™é‡Œè¿˜ä»€ä¹ˆéƒ½æ²¡æœ‰</p>
                <a href="/add" class="btn btn-primary">å»è®°å½•ä¸€ç¬”</a>
            </div>
            <!-- æµ·æŠ¥å¢™å®¹å™¨ -->
            <div id="items-grid" class="items-grid"></div>
        </div>
    </main>

    <script src="/static/js/api.js?v=20260127"></script>
    <script src="/static/js/cover-picker.js?v=20260127"></script>
    <script src="/static/js/app.js?v=20260127"></script>
    <script src="/static/js/components.js?v=20260127"></script>
    <script>
        // å…¨å±€å˜é‡
        let allItems = [];
        let filteredItems = [];
        let categories = [];
        let currentFilters = {};

        // åˆå§‹åŒ–
        async function init() {
            console.log('é¡µé¢åˆå§‹åŒ–å¼€å§‹...');
            try {
                if (typeof window.renderHeader === 'function') {
                    window.renderHeader('index');
                } else {
                    console.error('renderHeader å‡½æ•°æœªæ‰¾åˆ°ï¼');
                }
                setupSearch();
                await loadCategories();
                setupFilters();
                const currentYear = new Date().getFullYear();
                await loadItems({ year: currentYear }, '', currentYear.toString());
                setupYearDropdownToggle();
                console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                
                // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                let errorMessage = 'é¡µé¢åŠ è½½å¤±è´¥: ' + error.message;
                if (error.status === 401) {
                    errorMessage = 'è®¤è¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢å¹¶é‡æ–°ç™»å½•';
                } else if (error.message.includes('ç½‘ç»œ')) {
                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•';
                }
                
                showMessage(errorMessage, 'error');
                
                // åœ¨æ§åˆ¶å°æ˜¾ç¤ºæ›´å¤šè°ƒè¯•ä¿¡æ¯
                console.error('è°ƒè¯•ä¿¡æ¯:', {
                    API_BASE_URL: window.API_BASE_URL,
                    currentURL: window.location.href,
                    error: error
                });
            }
            setTimeout(() => {
                const y = new Date().getFullYear();
                const yearEl = document.querySelector('.stat-year-item[data-year="' + y + '"]');
                if (yearEl) yearEl.classList.add('active');
                const allCat = document.querySelector('.stat-category-item[data-category-id=""]');
                if (allCat) allCat.classList.add('active');
            }, 100);
        }

        // è®¾ç½®æœç´¢åŠŸèƒ½
        function setupSearch() {
            const searchInput = document.getElementById('search-input');
            const searchClear = document.getElementById('search-clear');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const value = e.target.value.trim();
                    if (searchClear) searchClear.style.display = value ? 'block' : 'none';
                    if (typeof window.handleSearch === 'function') window.handleSearch(value);
                });
            }
            if (searchClear && searchInput) {
                searchClear.addEventListener('click', function() {
                    searchInput.value = '';
                    searchClear.style.display = 'none';
                    if (typeof window.handleSearch === 'function') window.handleSearch('');
                });
            }
        }

        // åŠ è½½åˆ†ç±»åˆ—è¡¨å¹¶æ¸²æŸ“ä¸º tab
        async function loadCategories() {
            try {
                console.log('åŠ è½½åˆ†ç±»åˆ—è¡¨...');
                console.log('è°ƒç”¨ CategoriesAPI.getAll()...');
                categories = await CategoriesAPI.getAll();
                console.log('åˆ†ç±»åˆ—è¡¨åŠ è½½æˆåŠŸ:', categories.length, 'ä¸ªåˆ†ç±»');
                
                // åˆ›å»ºä¸´æ—¶çš„åˆ†ç±»tabså®¹å™¨ï¼ˆç”¨äºè·å–HTMLï¼‰
                const tempContainer = document.createElement('div');
                tempContainer.id = 'category-filter-tabs';
                tempContainer.className = 'category-filter-tabs';
                
                // æ·»åŠ "å…¨éƒ¨"æŒ‰é’®
                const allTab = document.createElement('button');
                allTab.type = 'button';
                allTab.className = 'category-filter-tab active';
                allTab.textContent = 'å…¨éƒ¨';
                allTab.dataset.categoryId = '';
                tempContainer.appendChild(allTab);
                
                // æ·»åŠ å…¶ä»–åˆ†ç±» tab
                categories.forEach(cat => {
                    const tab = document.createElement('button');
                    tab.type = 'button';
                    tab.className = 'category-filter-tab';
                    tab.textContent = cat.name;
                    tab.dataset.categoryId = cat.id;
                    tempContainer.appendChild(tab);
                });
                
                // å°†ä¸´æ—¶å®¹å™¨æ·»åŠ åˆ°é¡µé¢ï¼ˆéšè—ï¼‰
                tempContainer.style.display = 'none';
                document.body.appendChild(tempContainer);
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
                tempContainer.addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-filter-tab')) {
                        // ç§»é™¤æ‰€æœ‰ tab çš„ active çŠ¶æ€
                        document.querySelectorAll('.category-filter-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        // æ·»åŠ å½“å‰ tab çš„ active çŠ¶æ€
                        e.target.classList.add('active');
                        
                        // åº”ç”¨ç­›é€‰
                        applyFilters();
                    }
                });
            } catch (error) {
                showMessage('åŠ è½½åˆ†ç±»å¤±è´¥: ' + error.message, 'error');
            }
        }

        // é¦–é¡µç»Ÿè®¡ + å¹´ä»½ä¸‹æ‹‰ + ç­›é€‰èƒ¶å›Šï¼ˆæ–°è®¾è®¡ï¼‰
        async function renderHomeStats(selectedYear, selectedCategoryId) {
            const statTotalEl = document.getElementById('stat-total');
            const yearLabelEl = document.getElementById('year-dropdown-label');
            const yearDropdownEl = document.getElementById('year-dropdown');
            const chipsContainer = document.getElementById('filter-chips');
            if (!statTotalEl || !chipsContainer) return;
            try {
                const stats = await ItemsAPI.getStatistics(selectedYear || new Date().getFullYear());
                let availableYears = [];
                try {
                    const res = await ItemsAPI.getAvailableYears();
                    availableYears = (res.years || []).map(String);
                } catch (e) {}
                if (availableYears.length === 0) availableYears.push(String(new Date().getFullYear()));
                statTotalEl.textContent = stats.total ?? 0;
                yearLabelEl.textContent = selectedYear || 'å…¨éƒ¨å¹´ä»½';
                // å¹´ä»½ä¸‹æ‹‰
                yearDropdownEl.innerHTML = '';
                yearDropdownEl.style.display = 'none';
                const allYearBtn = document.createElement('button');
                allYearBtn.type = 'button';
                allYearBtn.className = 'stat-year-item home-year-option' + (!selectedYear ? ' active' : '');
                allYearBtn.dataset.year = '';
                allYearBtn.textContent = 'å…¨éƒ¨å¹´ä»½';
                allYearBtn.addEventListener('click', function() { filterByYear(''); yearDropdownEl.style.display = 'none'; });
                yearDropdownEl.appendChild(allYearBtn);
                availableYears.forEach(y => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'stat-year-item home-year-option' + (selectedYear === y ? ' active' : '');
                    btn.dataset.year = y;
                    btn.textContent = y;
                    btn.addEventListener('click', function() { filterByYear(y); yearDropdownEl.style.display = 'none'; });
                    yearDropdownEl.appendChild(btn);
                });
                // ç­›é€‰èƒ¶å›Šï¼šå…¨éƒ¨ + å„åˆ†ç±»
                const byCat = stats.by_category || {};
                const totalCount = stats.total || 0;
                chipsContainer.innerHTML = '';
                const allChip = document.createElement('button');
                allChip.type = 'button';
                allChip.className = 'stat-category-item home-chip' + (!selectedCategoryId ? ' active' : '');
                allChip.dataset.categoryId = '';
                allChip.innerHTML = '<span>å…¨éƒ¨</span><span class="home-chip-count">' + totalCount + '</span>';
                allChip.addEventListener('click', function() { filterByCategory(''); });
                chipsContainer.appendChild(allChip);
                Object.entries(byCat).forEach(([name, count]) => {
                    const cat = categories.find(c => c.name === name);
                    const cid = cat ? String(cat.id) : '';
                    const isActive = selectedCategoryId && cid === String(selectedCategoryId);
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'stat-category-item home-chip' + (isActive ? ' active' : '');
                    btn.dataset.categoryId = cid;
                    btn.innerHTML = '<span>' + name + '</span><span class="home-chip-count">' + count + '</span>';
                    btn.addEventListener('click', function() { filterByCategory(cid); });
                    chipsContainer.appendChild(btn);
                });
            } catch (err) {
                console.error('renderHomeStats:', err);
            }
        }

        function setupYearDropdownToggle() {
            const btn = document.getElementById('year-dropdown-btn');
            const panel = document.getElementById('year-dropdown');
            if (!btn || !panel) return;
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            });
            document.addEventListener('click', function() { panel.style.display = 'none'; });
        }

        // åŠ è½½è®°å½•åˆ—è¡¨
        async function loadItems(params = {}, categoryId = '', year = '') {
            console.log('loadItems è°ƒç”¨:', { params, categoryId, year });
            const loading = document.getElementById('loading');
            const emptyState = document.getElementById('empty-state');
            const grid = document.getElementById('items-grid');
            
            loading.style.display = 'block';
            grid.innerHTML = '';
            
            try {
                console.log('åŠ è½½è®°å½•åˆ—è¡¨...', params);
                allItems = await ItemsAPI.getAll(params);
                console.log('è®°å½•åˆ—è¡¨åŠ è½½æˆåŠŸ:', allItems.length, 'æ¡è®°å½•');
                currentFilters = params;
                filteredItems = [...allItems];
                
                const statsYear = params.year || new Date().getFullYear();
                const statsCategoryId = categoryId || params.category_id || '';
                await renderHomeStats(statsYear.toString(), statsCategoryId);
                
                loading.style.display = 'none';
                
                if (filteredItems.length === 0) {
                    emptyState.style.display = 'block';
                    return;
                }
                
                emptyState.style.display = 'none';
                renderItems(filteredItems);
            } catch (error) {
                console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
                loading.style.display = 'none';
                showMessage('åŠ è½½è®°å½•å¤±è´¥: ' + error.message, 'error');
                // é¿å…æ— é™é‡è¯•ï¼Œåªæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            }
        }
        
        // æœç´¢å¤„ç†
        window.handleSearch = debounce(function(searchTerm) {
            if (!searchTerm.trim()) {
                filteredItems = [...allItems];
            } else {
                const term = searchTerm.toLowerCase();
                filteredItems = allItems.filter(item => {
                    const titleMatch = item.title.toLowerCase().includes(term);
                    const notesMatch = item.notes && item.notes.toLowerCase().includes(term);
                    return titleMatch || notesMatch;
                });
            }
            
            const emptyState = document.getElementById('empty-state');
            const grid = document.getElementById('items-grid');
            
            if (filteredItems.length === 0) {
                emptyState.style.display = 'block';
                grid.innerHTML = '';
            } else {
                emptyState.style.display = 'none';
                renderItems(filteredItems);
            }
        }, 300);

        // æ¸²æŸ“è®°å½•å¡ç‰‡
        function renderItems(items) {
            const grid = document.getElementById('items-grid');
            grid.innerHTML = '';
            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                card.onclick = (e) => {
                    if (e.target.closest('.item-delete-btn')) return;
                    showItemDetail(item);
                };
                const coverImage = item.images && item.images.length > 0
                    ? item.images[0].image_url
                    : '/static/images/placeholder.svg';
                card.innerHTML = `
                    <div class="item-card-image">
                        <div class="item-badge">${item.category_name}</div>
                        <img src="${coverImage}" loading="lazy" alt="${item.title}" onerror="this.src='/static/images/placeholder.svg'">
                        <div class="item-overlay">
                            <h3 class="item-title">${item.title}</h3>
                            <div class="item-meta">
                                <span>${formatDate(item.finish_time)}</span>
                                ${item.images && item.images.length > 1 ? '<span>ğŸ“· ' + item.images.length + '</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'item-delete-btn';
                deleteBtn.innerHTML = 'ğŸ—‘ï¸';
                deleteBtn.title = 'åˆ é™¤';
                deleteBtn.style.display = 'none';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', () => { deleteItem(item.id); });
                });
                card.appendChild(deleteBtn);
                let longPressTimer, isLongPress = false, deleteBtnVisible = false;
                card.addEventListener('touchstart', function(e) {
                    isLongPress = false;
                    longPressTimer = setTimeout(() => {
                        isLongPress = true;
                        deleteBtnVisible = true;
                        e.preventDefault();
                        deleteBtn.style.display = 'flex';
                        if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
                        card.style.transform = 'scale(0.98)';
                        setTimeout(() => { card.style.transform = ''; }, 200);
                    }, 2000);
                });
                card.addEventListener('touchend', function() {
                    clearTimeout(longPressTimer);
                    if (!isLongPress) deleteBtn.style.display = 'none';
                });
                card.addEventListener('touchmove', function() {
                    clearTimeout(longPressTimer);
                    isLongPress = false;
                    deleteBtnVisible = false;
                    deleteBtn.style.display = 'none';
                });
                card.addEventListener('click', function(e) {
                    if (deleteBtnVisible && e.target !== deleteBtn && !deleteBtn.contains(e.target)) {
                        deleteBtn.style.display = 'none';
                        deleteBtnVisible = false;
                    }
                });
                card.addEventListener('mouseenter', function() { deleteBtn.style.display = 'flex'; });
                card.addEventListener('mouseleave', function() { deleteBtn.style.display = 'none'; });
                card.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', () => { deleteItem(item.id); });
                });
                grid.appendChild(card);
            });
        }

        // è®¾ç½®ç­›é€‰å™¨
        async function setupFilters() {
            // åˆ›å»ºå¹´ä»½é€‰æ‹©å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
            let yearFilter = document.getElementById('year-filter');
            if (!yearFilter) {
                yearFilter = document.createElement('select');
                yearFilter.id = 'year-filter';
                yearFilter.className = 'filter-select';
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'å…¨éƒ¨å¹´ä»½';
                yearFilter.appendChild(defaultOption);
                document.body.appendChild(yearFilter);
                yearFilter.style.display = 'none';
            }
            
            // ä»APIè·å–æœ‰è®°å½•çš„å¹´ä»½
            try {
                const response = await ItemsAPI.getAvailableYears();
                const years = response.years || [];
                const currentYear = new Date().getFullYear();
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†ç¬¬ä¸€ä¸ªï¼‰
                while (yearFilter.children.length > 1) {
                    yearFilter.removeChild(yearFilter.lastChild);
                }
                
                // å¦‚æœæœ‰è®°å½•çš„å¹´ä»½åˆ—è¡¨ä¸ºç©ºï¼Œä½¿ç”¨å½“å‰å¹´
                if (years.length === 0) {
                    years.push(currentYear);
                }
                
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    // è®¾ç½®å½“å‰å¹´ä¸ºé»˜è®¤é€‰ä¸­ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearFilter.appendChild(option);
                });
                
                // å¦‚æœæ²¡æœ‰å½“å‰å¹´ï¼Œé»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªå¹´ä»½
                if (!yearFilter.value && years.length > 0) {
                    yearFilter.value = years[0];
                }
            } catch (error) {
                console.error('è·å–å¹´ä»½åˆ—è¡¨å¤±è´¥:', error);
                // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤å¹´ä»½åˆ—è¡¨
                const years = getYearOptions(2020);
                const currentYear = new Date().getFullYear();
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    yearFilter.appendChild(option);
                });
            }
            
            // è®¾ç½®æ»šåŠ¨ç›‘å¬ï¼Œæ˜¾ç¤ºæœç´¢æ¡†
            setupScrollSearch();
        }
        
        // è®¾ç½®ç­›é€‰å™¨äº‹ä»¶ï¼ˆåœ¨ç»Ÿè®¡å¡ç‰‡å†…éƒ¨ï¼‰
        window.setupFilterEvents = function() {
            // ç»‘å®šåˆ†ç±»tabsäº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
            const categoryTabsInner = document.getElementById('category-filter-tabs-inner');
            if (categoryTabsInner) {
                categoryTabsInner.addEventListener('click', function(e) {
                    if (e.target.classList.contains('category-filter-tab')) {
                        // åŒæ­¥æ›´æ–°éšè—çš„åŸå§‹tabs
                        const originalTabs = document.getElementById('category-filter-tabs');
                        if (originalTabs) {
                            originalTabs.querySelectorAll('.category-filter-tab').forEach(t => {
                                t.classList.remove('active');
                                if (t.dataset.categoryId === e.target.dataset.categoryId) {
                                    t.classList.add('active');
                                }
                            });
                        }
                        
                        // ç§»é™¤æ‰€æœ‰ tab çš„ active çŠ¶æ€
                        document.querySelectorAll('.category-filter-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        // æ·»åŠ å½“å‰ tab çš„ active çŠ¶æ€
                        e.target.classList.add('active');
                        
                        // åº”ç”¨ç­›é€‰
                        applyFilters();
                    }
                });
            }
            
            // ç»‘å®šå¹´ä»½é€‰æ‹©å™¨äº‹ä»¶
            const yearFilterInner = document.getElementById('year-filter-inner');
            if (yearFilterInner) {
                yearFilterInner.addEventListener('change', function() {
                    // åŒæ­¥æ›´æ–°åŸå§‹çš„å¹´ä»½é€‰æ‹©å™¨
                    const originalYearFilter = document.getElementById('year-filter');
                    if (originalYearFilter && originalYearFilter !== yearFilterInner) {
                        originalYearFilter.value = this.value;
                    }
                    applyFilters();
                });
            }
        };
        
        // è®¾ç½®æ»šåŠ¨ç›‘å¬ï¼Œå½“ç”¨æˆ·æ»šåŠ¨æ—¶æ˜¾ç¤ºæœç´¢æ¡†
        function setupScrollSearch() {
            const searchWrapper = document.getElementById('search-wrapper');
            let lastScrollTop = 0;
            let scrollTimeout;
            
            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                clearTimeout(scrollTimeout);
                
                // å¦‚æœå‘ä¸‹æ»šåŠ¨è¶…è¿‡ 100pxï¼Œæ˜¾ç¤ºæœç´¢æ¡†
                if (scrollTop > 100 && scrollTop > lastScrollTop) {
                    searchWrapper.style.display = 'block';
                    searchWrapper.style.opacity = '0';
                    setTimeout(() => {
                        searchWrapper.style.transition = 'opacity 0.3s';
                        searchWrapper.style.opacity = '1';
                    }, 10);
                }
                
                // å¦‚æœæ»šåŠ¨åˆ°é¡¶éƒ¨ï¼Œéšè—æœç´¢æ¡†
                if (scrollTop < 50) {
                    searchWrapper.style.opacity = '0';
                    scrollTimeout = setTimeout(() => {
                        searchWrapper.style.display = 'none';
                    }, 300);
                }
                
                lastScrollTop = scrollTop;
            });
        }

        // é€šè¿‡åˆ†ç±»ç­›é€‰
        window.filterByCategory = function(categoryId) {
            const id = String(categoryId ?? '');
            document.querySelectorAll('.stat-category-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.categoryId === id) {
                    item.classList.add('active');
                }
            });
            
            // è·å–å½“å‰é€‰ä¸­çš„å¹´ä»½
            const activeYearItem = document.querySelector('.stat-year-item.active');
            const year = activeYearItem ? activeYearItem.dataset.year : '';
            
            const params = {};
            if (id) params.category_id = parseInt(id, 10) || id;
            if (year) params.year = parseInt(year);
            const searchInput = document.getElementById('search-input');
            if (searchInput) { searchInput.value = ''; if (typeof window.handleSearch === 'function') window.handleSearch(''); }
            const searchClear = document.getElementById('search-clear');
            if (searchClear) searchClear.style.display = 'none';
            loadItems(params, id, year);
        };
        
        // é€šè¿‡å¹´ä»½ç­›é€‰
        window.filterByYear = function(year) {
            // æ›´æ–°å¹´ä»½é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.stat-year-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.year === year) {
                    item.classList.add('active');
                }
            });
            
            // è·å–å½“å‰é€‰ä¸­çš„åˆ†ç±»
            const activeCategoryItem = document.querySelector('.stat-category-item.active');
            const categoryId = activeCategoryItem ? activeCategoryItem.dataset.categoryId : '';
            
            const params = {};
            if (categoryId) params.category_id = categoryId;
            if (year) params.year = parseInt(year);
            
            // æ¸…é™¤æœç´¢æ¡†
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                if (typeof window.handleSearch === 'function') {
                    window.handleSearch('');
                }
            }
            const searchClear = document.getElementById('search-clear');
            if (searchClear) searchClear.style.display = 'none';
            
            loadItems(params, categoryId, year);
        };
        
        // åº”ç”¨ç­›é€‰ï¼ˆä¿ç•™ç”¨äºå…¶ä»–åœºæ™¯ï¼‰
        function applyFilters() {
            // è·å–é€‰ä¸­çš„åˆ†ç±»
            const activeCategoryItem = document.querySelector('.stat-category-item.active');
            const categoryId = activeCategoryItem ? activeCategoryItem.dataset.categoryId : '';
            
            // è·å–é€‰ä¸­çš„å¹´ä»½
            const activeYearItem = document.querySelector('.stat-year-item.active');
            const year = activeYearItem ? activeYearItem.dataset.year : '';
            
            const params = {};
            if (categoryId) params.category_id = categoryId;
            if (year) params.year = parseInt(year);
            
            // æ¸…é™¤æœç´¢æ¡†
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                if (typeof window.handleSearch === 'function') {
                    window.handleSearch('');
                }
            }
            const searchClear = document.getElementById('search-clear');
            if (searchClear) searchClear.style.display = 'none';
            
            loadItems(params, categoryId, year);
        }

        // æ˜¾ç¤ºé¡¹ç›®è¯¦æƒ…
        function showItemDetail(item) {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'item-detail-overlay';
            
            // åˆ›å»ºè¯¦æƒ…å¯¹è¯æ¡†
            const dialog = document.createElement('div');
            dialog.className = 'item-detail-dialog';
            
            // æ„å»ºå›¾ç‰‡ç½‘æ ¼
            let imagesHTML = '';
            if (item.images && item.images.length > 0) {
                imagesHTML = `
                    <div class="item-detail-images" id="item-detail-images-${item.id}">
                        ${item.images.map((img, idx) => `
                            <div class="item-detail-image-item" data-image-id="${img.id}">
                                <img src="${img.image_url}" alt="å›¾ç‰‡ ${idx + 1}">
                                <button class="item-image-delete" onclick="deleteImageFromDetail(${img.id}, ${item.id}, this.closest('.item-detail-overlay'))" title="åˆ é™¤å›¾ç‰‡">âœ•</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                imagesHTML = `<div class="item-detail-images" id="item-detail-images-${item.id}"></div>`;
            }
            
            dialog.innerHTML = `
                <div class="item-detail-content">
                    <button class="item-detail-close" onclick="closeDetailDialog(this.closest('.item-detail-overlay'))">âœ•</button>
                    <div class="item-detail-header">
                        <div class="item-detail-badge">${item.category_name}</div>
                        <h2 class="item-detail-title">${item.title}</h2>
                        <div class="item-detail-date">
                            <span class="date-icon">ğŸ“…</span>
                            ${formatDate(item.finish_time)}
                        </div>
                    </div>
                    ${item.notes ? `
                        <div class="item-detail-notes">
                            <h3>å¤‡æ³¨/æ„Ÿæƒ³</h3>
                            <p>${item.notes}</p>
                        </div>
                    ` : ''}
                    <div class="item-detail-images-section">
                        <div class="item-detail-images-header">
                            <h3>å›¾ç‰‡</h3>
                            <label class="btn btn-secondary btn-sm" style="margin: 0;">
                                æ·»åŠ å›¾ç‰‡
                                <input type="file" 
                                       id="add-images-${item.id}" 
                                       multiple 
                                       accept="image/*" 
                                       style="display: none;"
                                       onchange="handleAddImages(${item.id}, this.closest('.item-detail-overlay'))">
                            </label>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="openDetailCoverPicker(${item.id}, this.closest('.item-detail-overlay'))">æœç´¢å°é¢</button>
                        </div>
                        ${imagesHTML}
                    </div>
                    <div class="item-detail-actions">
                        <button class="btn btn-danger" onclick="deleteItemFromDetail(${item.id}, this.closest('.item-detail-overlay'))">åˆ é™¤è®°å½•</button>
                    </div>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // å­˜å‚¨å½“å‰itemæ•°æ®åˆ°overlayï¼Œæ–¹ä¾¿åç»­æ›´æ–°
            overlay.dataset.itemId = item.id;
            overlay.dataset.currentImages = JSON.stringify(item.images || []);
            
            // ä¸ºå›¾ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼ˆæŸ¥çœ‹å¤§å›¾ï¼‰
            const imageItems = dialog.querySelectorAll('.item-detail-image-item');
            imageItems.forEach((itemEl, idx) => {
                const img = itemEl.querySelector('img');
                if (img) {
                    img.addEventListener('click', (e) => {
                        // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯åˆ é™¤æŒ‰é’®ï¼Œåˆ™æŸ¥çœ‹å¤§å›¾
                        if (!e.target.closest('.item-image-delete')) {
                            const currentImages = JSON.parse(overlay.dataset.currentImages);
                            createImageViewer(currentImages, idx);
                        }
                    });
                }
            });
            
            // æ·»åŠ åŠ¨ç”»
            setTimeout(() => {
                overlay.classList.add('show');
            }, 10);
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    closeDetailDialog(overlay);
                }
            });
            
            // ESC é”®å…³é—­
            const escHandler = (e) => {
                if (e.key === 'Escape') {
                    closeDetailDialog(overlay);
                    document.removeEventListener('keydown', escHandler);
                }
            };
            document.addEventListener('keydown', escHandler);
        }
        
        // è¯¦æƒ…å¼¹çª—å†…ã€Œæœç´¢å°é¢ã€ï¼šç”¨ CoverPicker é€‰å›¾åè°ƒç”¨æ¥å£å¹¶åˆ·æ–°åˆ—è¡¨
        function openDetailCoverPicker(itemId, overlay) {
            var titleEl = overlay.querySelector('.item-detail-title');
            var initialSearch = titleEl ? titleEl.textContent.trim() : '';
            CoverPicker.open({
                initialSearch: initialSearch,
                onSelect: function(coverUrl) {
                    ItemsAPI.addCoverFromUrl(itemId, coverUrl).then(function(newImages) {
                        // æ¥å£è¿”å›è¯¥æ¡ç›®çš„å®Œæ•´å›¾ç‰‡åˆ—è¡¨ï¼ˆæ–°å°é¢å·²æ’åœ¨æœ€å‰ï¼‰ï¼Œç›´æ¥æ›¿æ¢
                        overlay.dataset.currentImages = JSON.stringify(newImages);
                        refreshDetailImages(overlay, itemId, newImages);
                        if (typeof showMessage === 'function') showMessage('å°é¢å·²æ·»åŠ ', 'success');
                    }).catch(function(err) {
                        if (typeof showMessage === 'function') showMessage('æ·»åŠ å¤±è´¥: ' + err.message, 'error');
                    });
                }
            });
        }
        window.openDetailCoverPicker = openDetailCoverPicker;

        // åˆ·æ–°è¯¦æƒ…å¼¹çª—å†…çš„å›¾ç‰‡ç½‘æ ¼ï¼ˆæ·»åŠ å›¾ç‰‡ / æœç´¢å°é¢ åå…±ç”¨ï¼‰
        function refreshDetailImages(overlay, itemId, existingImages) {
            var imagesContainer = overlay.querySelector('#item-detail-images-' + itemId);
            if (!imagesContainer) return;
            imagesContainer.innerHTML = existingImages.map(function(img, idx) {
                return '<div class="item-detail-image-item" data-image-id="' + img.id + '">' +
                    '<img src="' + img.image_url + '" alt="å›¾ç‰‡ ' + (idx + 1) + '">' +
                    '<button class="item-image-delete" onclick="deleteImageFromDetail(' + img.id + ',' + itemId + ', this.closest(\'.item-detail-overlay\'))" title="åˆ é™¤å›¾ç‰‡">âœ•</button></div>';
            }).join('');
            imagesContainer.querySelectorAll('.item-detail-image-item').forEach(function(itemEl, idx) {
                var img = itemEl.querySelector('img');
                if (img) img.addEventListener('click', function(e) {
                    if (!e.target.closest('.item-image-delete')) createImageViewer(existingImages, idx);
                });
            });
        }

        // å¤„ç†æ·»åŠ å›¾ç‰‡
        async function handleAddImages(itemId, overlay) {
            const fileInput = document.getElementById(`add-images-${itemId}`);
            const files = fileInput.files;
            
            if (!files || files.length === 0) {
                return;
            }
            
            try {
                const formData = new FormData();
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }
                
                const newImages = await ItemsAPI.addImages(itemId, formData);
                
                var currentImages = JSON.parse(overlay.dataset.currentImages || '[]');
                currentImages.push.apply(currentImages, newImages);
                overlay.dataset.currentImages = JSON.stringify(currentImages);
                
                refreshDetailImages(overlay, itemId, currentImages);
                showMessage('å›¾ç‰‡æ·»åŠ æˆåŠŸ', 'success');
                fileInput.value = '';
                applyFilters();
            } catch (error) {
                showMessage('æ·»åŠ å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // åˆ é™¤å›¾ç‰‡
        async function deleteImageFromDetail(imageId, itemId, overlay) {
            showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ', async () => {
                try {
                    await ItemsAPI.deleteImage(imageId);
                    
                    // æ›´æ–°overlayä¸­çš„å›¾ç‰‡æ•°æ®
                    const currentImages = JSON.parse(overlay.dataset.currentImages || '[]');
                    const updatedImages = currentImages.filter(img => img.id !== imageId);
                    overlay.dataset.currentImages = JSON.stringify(updatedImages);
                    
                    // é‡æ–°æ¸²æŸ“å›¾ç‰‡ç½‘æ ¼
                    const imagesContainer = overlay.querySelector(`#item-detail-images-${itemId}`);
                    
                    if (updatedImages.length === 0) {
                        imagesContainer.innerHTML = '';
                    } else {
                        imagesContainer.innerHTML = updatedImages.map((img, idx) => `
                            <div class="item-detail-image-item" data-image-id="${img.id}">
                                <img src="${img.image_url}" alt="å›¾ç‰‡ ${idx + 1}">
                                <button class="item-image-delete" onclick="deleteImageFromDetail(${img.id}, ${itemId}, this.closest('.item-detail-overlay'))" title="åˆ é™¤å›¾ç‰‡">âœ•</button>
                            </div>
                        `).join('');
                        
                        // é‡æ–°ç»‘å®šå›¾ç‰‡ç‚¹å‡»äº‹ä»¶
                        const imageItems = imagesContainer.querySelectorAll('.item-detail-image-item');
                        imageItems.forEach((itemEl, idx) => {
                            const img = itemEl.querySelector('img');
                            if (img) {
                                img.addEventListener('click', (e) => {
                                    if (!e.target.closest('.item-image-delete')) {
                                        createImageViewer(updatedImages, idx);
                                    }
                                });
                            }
                        });
                    }
                    
                    showMessage('å›¾ç‰‡åˆ é™¤æˆåŠŸ', 'success');
                    
                    // åˆ·æ–°åˆ—è¡¨
                    applyFilters();
                } catch (error) {
                    showMessage('åˆ é™¤å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
                }
            });
        }
        
        // å…³é—­è¯¦æƒ…å¯¹è¯æ¡†
        function closeDetailDialog(overlay) {
            overlay.classList.remove('show');
            setTimeout(() => {
                overlay.remove();
            }, 300);
        }
        
        // ä»è¯¦æƒ…å¯¹è¯æ¡†åˆ é™¤è®°å½•
        async function deleteItemFromDetail(id, overlay) {
            showConfirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ', async () => {
                try {
                    await ItemsAPI.delete(id);
                    showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    closeDetailDialog(overlay);
                    applyFilters(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } catch (error) {
                    showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                }
            });
        }
        
        // åˆ é™¤è®°å½•
        async function deleteItem(id) {
            try {
                await ItemsAPI.delete(id);
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                applyFilters(); // é‡æ–°åŠ è½½åˆ—è¡¨
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // ä¸‹æ‹‰åˆ·æ–°åŠŸèƒ½ï¼ˆæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°åŠ è½½ï¼‰
        let pullToRefresh = {
            startY: 0,
            currentY: 0,
            isPulling: false,
            threshold: 80, // ä¸‹æ‹‰é˜ˆå€¼ï¼ˆåƒç´ ï¼‰
            refreshElement: null,
            
            init: function() {
                this.refreshElement = document.getElementById('pull-to-refresh');
                if (!this.refreshElement) return;
                
                // ç›‘å¬è§¦æ‘¸äº‹ä»¶
                document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: false });
                document.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: false });
            },
            
            handleTouchStart: function(e) {
                // æ’é™¤é“¾æ¥ã€æŒ‰é’®å’Œ header åŒºåŸŸ
                const target = e.target;
                if (target.closest('a') || target.closest('button') || target.closest('header')) {
                    this.isPulling = false;
                    return;
                }
                
                // åªåœ¨é¡µé¢é¡¶éƒ¨ä¸”å‘ä¸‹æ»šåŠ¨æ—¶è§¦å‘
                if (window.scrollY === 0) {
                    this.startY = e.touches[0].clientY;
                    this.isPulling = true;
                }
            },
            
            handleTouchMove: function(e) {
                // æ’é™¤é“¾æ¥ã€æŒ‰é’®å’Œ header åŒºåŸŸ
                const target = e.target;
                if (target.closest('a') || target.closest('button') || target.closest('header')) {
                    this.isPulling = false;
                    this.resetUI();
                    return;
                }
                
                if (!this.isPulling) return;
                
                this.currentY = e.touches[0].clientY;
                const deltaY = this.currentY - this.startY;
                
                // åªåœ¨ä¸‹æ‹‰æ—¶è§¦å‘
                if (deltaY > 0 && window.scrollY === 0) {
                    e.preventDefault(); // é˜»æ­¢é»˜è®¤æ»šåŠ¨
                    
                    const progress = Math.min(deltaY / this.threshold, 1);
                    this.updateUI(progress, deltaY);
                } else {
                    this.resetUI();
                }
            },
            
            handleTouchEnd: function(e) {
                // æ’é™¤é“¾æ¥ã€æŒ‰é’®å’Œ header åŒºåŸŸ
                const target = e.target;
                if (target.closest('a') || target.closest('button') || target.closest('header')) {
                    this.isPulling = false;
                    this.resetUI();
                    return;
                }
                
                if (!this.isPulling) return;
                
                const deltaY = this.currentY - this.startY;
                
                if (deltaY >= this.threshold) {
                    // è§¦å‘åˆ·æ–°
                    this.triggerRefresh();
                } else {
                    // é‡ç½®
                    this.resetUI();
                }
                
                this.isPulling = false;
            },
            
            updateUI: function(progress, deltaY) {
                if (!this.refreshElement) return;
                
                this.refreshElement.style.display = 'flex';
                this.refreshElement.style.opacity = progress;
                this.refreshElement.style.transform = `translateY(${Math.min(deltaY, this.threshold)}px)`;
                
                if (deltaY >= this.threshold) {
                    this.refreshElement.querySelector('.pull-to-refresh-text').textContent = 'é‡Šæ”¾ä»¥æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°';
                    this.refreshElement.querySelector('.pull-to-refresh-icon').textContent = 'â¬†ï¸';
                } else {
                    this.refreshElement.querySelector('.pull-to-refresh-text').textContent = 'ä¸‹æ‹‰åˆ·æ–°å¹¶æ¸…é™¤ç¼“å­˜';
                    this.refreshElement.querySelector('.pull-to-refresh-icon').textContent = 'â¬‡ï¸';
                }
            },
            
            resetUI: function() {
                if (!this.refreshElement) return;
                
                this.refreshElement.style.display = 'none';
                this.refreshElement.style.opacity = '0';
                this.refreshElement.style.transform = 'translateY(0)';
            },
            
            triggerRefresh: async function() {
                if (!this.refreshElement) return;
                
                this.refreshElement.querySelector('.pull-to-refresh-text').textContent = 'æ­£åœ¨æ¸…é™¤ç¼“å­˜...';
                this.refreshElement.querySelector('.pull-to-refresh-icon').textContent = 'ğŸ”„';
                
                try {
                    // æ¸…é™¤æ‰€æœ‰ç¼“å­˜
                    this.clearAllCache();
                    
                    // æ˜¾ç¤ºæç¤º
                    showMessage('ç¼“å­˜å·²æ¸…é™¤ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...', 'success');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await this.reloadData();
                    
                    // é‡ç½®UI
                    setTimeout(() => {
                        this.resetUI();
                        showMessage('åˆ·æ–°å®Œæˆï¼', 'success');
                    }, 500);
                    
                } catch (error) {
                    console.error('åˆ·æ–°å¤±è´¥:', error);
                    showMessage('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
                    this.resetUI();
                }
            },
            
            clearAllCache: function() {
                // æ¸…é™¤ localStorage
                try {
                    localStorage.clear();
                    console.log('å·²æ¸…é™¤ localStorage');
                } catch (e) {
                    console.warn('æ¸…é™¤ localStorage å¤±è´¥:', e);
                }
                
                // æ¸…é™¤ sessionStorage
                try {
                    sessionStorage.clear();
                    console.log('å·²æ¸…é™¤ sessionStorage');
                } catch (e) {
                    console.warn('æ¸…é™¤ sessionStorage å¤±è´¥:', e);
                }
                
                // æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼ˆé€šè¿‡æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶é‡æ–°åŠ è½½èµ„æºï¼‰
                const links = document.querySelectorAll('link[rel="stylesheet"]');
                links.forEach(link => {
                    if (link.href) {
                        const url = new URL(link.href);
                        url.searchParams.set('_t', Date.now());
                        link.href = url.toString();
                    }
                });
                
                // æ¸…é™¤å›¾ç‰‡ç¼“å­˜ï¼ˆé€šè¿‡æ·»åŠ æ—¶é—´æˆ³ï¼‰
                const images = document.querySelectorAll('img');
                images.forEach(img => {
                    if (img.src && !img.src.includes('data:')) {
                        const url = new URL(img.src);
                        url.searchParams.set('_t', Date.now());
                        img.src = url.toString();
                    }
                });
                
                console.log('å·²æ¸…é™¤æ‰€æœ‰ç¼“å­˜');
            },
            
            reloadData: async function() {
                // é‡æ–°åŠ è½½åˆ†ç±»
                await loadCategories();
                
                // é‡æ–°åŠ è½½æ•°æ®
                const currentYear = new Date().getFullYear();
                await loadItems({ year: currentYear }, '', currentYear.toString());
                
                // é‡æ–°è®¾ç½®ç­›é€‰å™¨
                setupFilters();
            }
        };

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            init();
            pullToRefresh.init();
        });
    </script>
</body>
</html>
